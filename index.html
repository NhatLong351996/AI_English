<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="UTF-8">
        <title>English Chat AI</title>
    <link rel="stylesheet" href="style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&display=swap" rel="stylesheet">
    </head>
<body>
    <nav id="sidebar">
    <!-- N√∫t m·ªü l·∫°i sidebar khi ƒë√£ ƒë√≥ng -->
    <button id="sidebar-open-btn" style="display:none;position:fixed;top:22px;left:10px;z-index:1001;background:#ede9fe;color:#7c3aed;border:none;border-radius:50%;width:38px;height:38px;box-shadow:0 2px 8px #ede9fe;align-items:center;justify-content:center;cursor:pointer;padding:0;">
        <svg viewBox="0 0 48 48" width="28" height="28">
            <g id="cat-head">
                <ellipse cx="24" cy="28" rx="12" ry="10" fill="#7c3aed"/>
                <ellipse cx="15" cy="16" rx="4" ry="6" fill="#7c3aed" transform="rotate(-20 15 16)"/>
                <ellipse cx="33" cy="16" rx="4" ry="6" fill="#7c3aed" transform="rotate(20 33 16)"/>
                <ellipse cx="20" cy="30" rx="2.5" ry="1.2" fill="#fff"/>
                <ellipse cx="28" cy="30" rx="2.5" ry="1.2" fill="#fff"/>
                <ellipse cx="20" cy="28" rx="1.2" ry="1.2" fill="#222"/>
                <ellipse cx="28" cy="28" rx="1.2" ry="1.2" fill="#222"/>
                <ellipse cx="24" cy="34" rx="2.5" ry="1.2" fill="#fff"/>
            </g>
        </svg>
    </button>
        <div class="sidebar-toggle" id="sidebar-toggle" title="·∫®n/hi·ªán thanh ch·ª©c nƒÉng">
            <span id="sidebar-cat" style="display:block;width:28px;height:28px;">
                <svg viewBox="0 0 48 48" width="28" height="28">
                    <g id="cat-head">
                        <ellipse cx="24" cy="28" rx="12" ry="10" fill="#7c3aed"/>
                        <ellipse cx="15" cy="16" rx="4" ry="6" fill="#7c3aed" transform="rotate(-20 15 16)"/>
                        <ellipse cx="33" cy="16" rx="4" ry="6" fill="#7c3aed" transform="rotate(20 33 16)"/>
                        <ellipse cx="20" cy="30" rx="2.5" ry="1.2" fill="#fff"/>
                        <ellipse cx="28" cy="30" rx="2.5" ry="1.2" fill="#fff"/>
                        <ellipse cx="20" cy="28" rx="1.2" ry="1.2" fill="#222"/>
                        <ellipse cx="28" cy="28" rx="1.2" ry="1.2" fill="#222"/>
                        <ellipse cx="24" cy="34" rx="2.5" ry="1.2" fill="#fff"/>
                    </g>
                </svg>
            </span>
        </div>
        <div class="logo-enhanced">
            <span class="logo-icon">üê±</span>
            <span class="logo-text">English AI</span>
        </div>
        <div class="sidebar-section-title">
            <span class="section-icon">‚ú®</span>
            <span class="section-text">Ch·ª©c nƒÉng</span>
        </div>
        <button class="sidebar-btn" id="home-btn"><span style="font-size:1.3rem;margin-right:7px;">üè°</span>Trang ch·ªß</button>
        <button class="sidebar-btn" id="practice-grammar-btn"><span style="font-size:1.3rem;margin-right:7px;">‚úèÔ∏è</span>Luy·ªán t·∫≠p s·ª≠a ng·ªØ ph√°p</button>
    <button class="sidebar-btn" id="practice-translate-btn"><span style="font-size:1.3rem;margin-right:7px;">üåè</span>Luy·ªán d·ªãch ch·ªß ƒë·ªÅ</button>
        <!-- C√≥ th·ªÉ th√™m c√°c ch·ª©c nƒÉng kh√°c ·ªü ƒë√¢y -->
    <!-- Modal ch·ªçn ch·ªß ƒë·ªÅ v√† m·ª©c ƒë·ªô -->
    <div id="translate-modal" class="modal" style="display:none;">
        <div class="modal-content">
            <div class="modal-title-topic-box">
                <span class="modal-title-icon">üìù</span>
                <span class="modal-title-topic-text">Ch·ªçn ch·ªß ƒë·ªÅ & m·ª©c ƒë·ªô</span>
            </div>
            <div style="margin-bottom:12px;">
                <div class="topic-radio-group-enhanced">
                    <label class="topic-radio-label-enhanced">
                        <input type="radio" name="topic-mode" id="topic-mode-select" value="select" checked>
                        <span class="radio-custom-enhanced">üéØ</span>
                        <span class="radio-title">Ch·ªß ƒë·ªÅ c√≥ s·∫µn</span>
                        <span class="radio-desc">(Ch·ªçn t·ª´ danh s√°ch c√°c ch·ªß ƒë·ªÅ ph·ªï bi·∫øn)</span>
                    </label>
                    <label class="topic-radio-label-enhanced">
                        <input type="radio" name="topic-mode" id="topic-mode-custom" value="custom">
                        <span class="radio-custom-enhanced">‚úèÔ∏è</span>
                        <span class="radio-title">T·ª± nh·∫≠p ch·ªß ƒë·ªÅ</span>
                        <span class="radio-desc">(B·∫°n t·ª± g√µ ch·ªß ƒë·ªÅ mu·ªën luy·ªán d·ªãch)</span>
                    </label>
                </div>
                <div id="topic-select-box">
                    <label for="topic-select">Ch·ªß ƒë·ªÅ:</label>
                    <select id="topic-select">
                        <option value="travel">Du l·ªãch</option>
                        <option value="school">H·ªçc t·∫≠p</option>
                        <option value="work">C√¥ng vi·ªác</option>
                        <option value="family">Gia ƒë√¨nh</option>
                        <option value="food">·∫®m th·ª±c</option>
                    </select>
                </div>
                <div id="custom-topic-box" style="display:none;margin-top:8px;">
                    <label for="custom-topic-input" style="color:#7c3aed;font-weight:500;">Nh·∫≠p ch·ªß ƒë·ªÅ b·∫°n mu·ªën:</label>
                    <input id="custom-topic-input" type="text" placeholder="V√≠ d·ª•: C√¥ng ngh·ªá, S·ª©c kh·ªèe, ..." style="margin-top:6px;width:92%;padding:8px 12px;border-radius:8px;border:1.5px solid #a78bfa;font-size:1.08rem;outline:none;box-shadow:0 1.5px 8px #ede9fe33;transition:border 0.18s;" />
                </div>
            </div>
            <div style="margin-bottom:18px;">
                <label for="level-select">M·ª©c ƒë·ªô:</label>
                <select id="level-select">
                    <option value="easy">D·ªÖ</option>
                    <option value="medium">Trung b√¨nh</option>
                    <option value="hard">Kh√≥</option>
                </select>
            </div>
            <button id="start-translate-btn" style="margin-right:10px;">B·∫Øt ƒë·∫ßu</button>
            <button id="close-translate-modal">H·ªßy</button>
        </div>
    </div>
    </nav>
    <div style="flex:1;display:flex;flex-direction:column;">
        <header>
            <span>üí¨</span> English Chat AI
            <div class="header-slogan">Luy·ªán d·ªãch & s·ª≠a ng·ªØ ph√°p ti·∫øng Anh th√¥ng minh</div>
        </header>
        <div id="main-content" style="flex:1;">
            <div id="home-page" style="display:block;padding:40px 24px;text-align:center;">
                <h2>Ch√†o m·ª´ng ƒë·∫øn v·ªõi English Chat AI!</h2>
                <p>Ch·ªçn ch·ª©c nƒÉng luy·ªán t·∫≠p ·ªü thanh b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Welcome" style="width:120px;margin-top:20px;opacity:0.8;">
            </div>
            <div id="chat-container" style="display:none;">
                <h2 style="display:none;">English Chat AI</h2>
                <div id="messages"></div>
                <div id="input-area">
                    <input type="text" id="user-input" placeholder="Type your English sentence..." />
                    <button id="send-btn">Send</button>
                </div>
            </div>
            <!-- Giao di·ªán luy·ªán d·ªãch ch·ªß ƒë·ªÅ -->
            <div id="translate-container" style="display:none;padding:32px 12px;max-width:520px;margin:0 auto;position:relative;">
                <div id="translate-info" class="translate-info-box translate-info-fixed"></div>
                <h2 style="text-align:center;margin-bottom:18px;display:flex;align-items:center;justify-content:center;gap:10px;">
                    <span class="cute-anim-icon" style="display:inline-block;animation:bounce 1.2s infinite alternate cubic-bezier(.5,1.5,.5,1);font-size:1.6em;">üêæ</span>
                    Luy·ªán d·ªãch theo ch·ªß ƒë·ªÅ
                </h2>
    <style>
    @keyframes bounce {
        0% { transform: translateY(0); }
        100% { transform: translateY(-12px) scale(1.15); }
    }
    .cute-anim-icon {
        will-change: transform;
        filter: drop-shadow(0 2px 6px #ede9fe);
    }
    </style>
                <div style="display:flex;align-items:center;justify-content:center;margin-bottom:18px;gap:10px;position:relative;">
                    <div id="vi-sentence-box" style="background:#ede9fe;border-radius:10px;padding:18px 14px;font-size:1.13rem;color:#5b21b6;min-height:32px;text-align:center;font-weight:500;"></div>
                    <button id="show-hint-btn" style="background:#fff;border:1.5px solid #a78bfa;color:#7c3aed;border-radius:50%;width:38px;height:38px;box-shadow:0 2px 8px #ede9fe;display:flex;align-items:center;justify-content:center;cursor:pointer;" title="Xem g·ª£i √Ω d·ªãch">
                        <span style="font-size:1.3em;">üí°</span>
                    </button>
                    <div id="hint-popup" style="display:none;position:absolute;left:110%;top:0;background:#fff;border:1.5px solid #a78bfa;border-radius:12px;box-shadow:0 4px 16px #ede9fe;padding:18px 20px;z-index:1002;min-width:260px;max-width:90vw;">
                        <div style="font-weight:600;color:#7c3aed;margin-bottom:8px;font-size:1.08em;">G·ª£i √Ω t·ª´ v·ª±ng & c·∫•u tr√∫c</div>
                        <div id="hint-content" style="color:#333;font-size:1.04em;"></div>
                        <button id="close-hint-btn" style="margin-top:10px;background:#ede9fe;color:#7c3aed;border:none;border-radius:7px;padding:5px 16px;font-weight:500;cursor:pointer;">ƒê√≥ng</button>
                    </div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
                    <input type="text" id="en-answer-input" placeholder="Nh·∫≠p c√¢u ti·∫øng Anh c·ªßa b·∫°n..." style="flex:1;font-size:1rem;padding:7px 10px;border-radius:7px;border:1px solid #a78bfa;" />
                    <button id="send-translate-btn" style="font-size:1rem;padding:7px 18px;border-radius:7px;background:linear-gradient(90deg,#a78bfa 0%,#7c3aed 100%);color:#fff;font-weight:600;border:none;">G·ª≠i</button>
                    <button id="next-vi-btn" style="font-size:1rem;padding:7px 14px;border-radius:7px;background:#e1f5fe;color:#7c3aed;font-weight:600;border:none;">C√¢u ti·∫øp theo</button>
                </div>
            <div id="translate-feedback" style="min-height:40px;margin-bottom:10px;"></div>
            <div id="translate-next-box" style="color:#7c3aed;font-size:0.98rem;text-align:center;"></div>
            <div style="display:flex;gap:18px;margin-top:18px;align-items:flex-start;">
                <div id="paragraph-view" style="flex:1;min-width:0;padding:12px 10px;background:#f3f4f6;border-radius:8px;"></div>
                <div id="translate-history-list" style="flex:1;min-width:0;"></div>
            </div>
            </div>
        </div>
        <footer>
            ¬© 2025 English Chat AI | Powered by Azure OpenAI & FastAPI
        </footer>
    </div>
    <script>
        // Luy·ªán d·ªãch ch·ªß ƒë·ªÅ: m·ªü modal ch·ªçn ch·ªß ƒë·ªÅ/m·ª©c ƒë·ªô
        document.getElementById('practice-translate-btn').onclick = function() {
            document.getElementById('translate-modal').style.display = 'block';
            // ·∫®n t·∫°m box Ch·ªß ƒë·ªÅ | M·ª©c ƒë·ªô khi m·ªü modal
            document.getElementById('translate-info').style.visibility = 'hidden';
        };
        document.getElementById('close-translate-modal').onclick = function() {
            document.getElementById('translate-modal').style.display = 'none';
            // Hi·ªán l·∫°i box Ch·ªß ƒë·ªÅ | M·ª©c ƒë·ªô n·∫øu c√≥ n·ªôi dung
            if (document.getElementById('translate-info').innerHTML.trim() !== '') {
                document.getElementById('translate-info').style.visibility = 'visible';
            }
        };
        // Chuy·ªÉn ƒë·ªïi gi·ªØa ch·ªçn ch·ªß ƒë·ªÅ c√≥ s·∫µn v√† t·ª± nh·∫≠p
        document.getElementById('topic-mode-select').onchange = function() {
            if (this.checked) {
                document.getElementById('topic-select-box').style.display = 'block';
                document.getElementById('custom-topic-box').style.display = 'none';
            }
        };
        document.getElementById('topic-mode-custom').onchange = function() {
            if (this.checked) {
                document.getElementById('topic-select-box').style.display = 'none';
                document.getElementById('custom-topic-box').style.display = 'block';
                document.getElementById('custom-topic-input').focus();
            }
        };
        document.getElementById('start-translate-btn').onclick = async function() {
            // Khi b·∫Øt ƒë·∫ßu ch·ªß ƒë·ªÅ m·ªõi, reset box
            document.getElementById('translate-info').style.visibility = 'visible';
            // ·∫®n modal, hi·ªÉn th·ªã giao di·ªán luy·ªán d·ªãch
            document.getElementById('translate-modal').style.display = 'none';
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('chat-container').style.display = 'none';
            document.getElementById('translate-container').style.display = 'block';
            // L·∫•y ch·ªß ƒë·ªÅ v√† m·ª©c ƒë·ªô
            let topic = '';
            if (document.getElementById('topic-mode-select').checked) {
                topic = document.getElementById('topic-select').value;
            } else {
                topic = document.getElementById('custom-topic-input').value.trim() || 'ch·ªß ƒë·ªÅ t·ª± ch·ªçn';
            }
            const level = document.getElementById('level-select').value;
            // Hi·ªÉn th·ªã th√¥ng tin ch·ªß ƒë·ªÅ, m·ª©c ƒë·ªô
            const topicMap = {travel:'Du l·ªãch',school:'H·ªçc t·∫≠p',work:'C√¥ng vi·ªác',family:'Gia ƒë√¨nh',food:'·∫®m th·ª±c'};
            const levelMap = {easy:'D·ªÖ',medium:'Trung b√¨nh',hard:'Kh√≥'};
            document.getElementById('translate-info').innerHTML =
                `<div class='translate-info-topic'><span class='info-icon'>üìö</span>Ch·ªß ƒë·ªÅ: <span>${topicMap[topic]||topic}</span></div>` +
                `<div class='translate-info-level'><span class='info-icon'>‚≠ê</span>M·ª©c ƒë·ªô: <span>${levelMap[level]||level}</span></div>`;
            // G·ªçi backend l·∫•y c√¢u ti·∫øng Vi·ªát ƒë·∫ßu ti√™n
            document.getElementById('vi-sentence-box').textContent = 'ƒêang l·∫•y c√¢u...';
            document.getElementById('en-answer-input').value = '';
            document.getElementById('translate-feedback').textContent = '';
            document.getElementById('translate-next-box').textContent = '';
            try {
                const res = await fetch('http://127.0.0.1:8000/translate/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, level })
                });
                const data = await res.json();
                document.getElementById('vi-sentence-box').textContent = data.vi_sentence;
                // L∆∞u tr·∫°ng th√°i cho phi√™n d·ªãch n√†y
                window.translateState = { topic, level, history: [data.vi_sentence], currentVi: data.vi_sentence };
                // ·∫®n popup g·ª£i √Ω n·∫øu ƒëang m·ªü
                document.getElementById('hint-popup').style.display = 'none';
                // ·∫®n popup g·ª£i √Ω n·∫øu ƒëang m·ªü
                document.getElementById('hint-popup').style.display = 'none';
            } catch (e) {
                document.getElementById('vi-sentence-box').textContent = 'L·ªói l·∫•y c√¢u, vui l√≤ng th·ª≠ l·∫°i.';
            }
        };
        // X·ª≠ l√Ω g·ª≠i c√¢u d·ªãch, ch·∫•m ƒëi·ªÉm v√† l·∫•y c√¢u ti·∫øp theo
        // H√†m parseFeedback: ∆∞u ti√™n parse JSON, fallback sang text n·∫øu c·∫ßn
        function parseFeedback(feedback, userAnswer) {
            let score = '';
            let correct = '';
            let user = userAnswer;
            let explanation = '';
            if (feedback) {
                // T√¨m JSON object trong feedback b·∫±ng regex
                const match = feedback.match(/\{[\s\S]*\}/);
                if (match) {
                    try {
                        const obj = JSON.parse(match[0]);
                        explanation = obj.explanation || '';
                        user = obj.user_answer || userAnswer;
                        correct = obj.correct_answer || '';
                        score = obj.score || '';
                        return { user, correct, score, explanation };
                    } catch (e) {
                        return { user, correct, score, explanation: '' };
                    }
                }
                // N·∫øu kh√¥ng ph·∫£i JSON, kh√¥ng hi·ªÉn th·ªã g√¨
                return { user, correct, score, explanation: '' };
            }
            return { user, correct, score, explanation };
        }

        document.getElementById('send-translate-btn').onclick = async function() {
            const userAnswer = document.getElementById('en-answer-input').value.trim();
            if (!userAnswer) return;
            const state = window.translateState;
            if (!state || !state.topic || !state.level || !state.currentVi) return;
            const feedbackDiv = document.getElementById('translate-feedback');
            feedbackDiv.innerHTML = '<span style="color:#7c3aed;font-weight:600;">ƒêang ch·∫•m...</span>';
            try {
                if (!state.history_bilingual) state.history_bilingual = [];
                const res = await fetch('http://127.0.0.1:8000/translate/next', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: state.topic,
                        level: state.level,
                        prev_history: state.history,
                        user_answer: userAnswer
                    })
                });
                const data = await res.json();
                document.getElementById('en-answer-input').value = '';
                // Ch·ªâ l·∫•y th√¥ng tin t·ª´ data.feedback (d√πng parseFeedback)
                let user = userAnswer, correct = '', score = '', explanation = '';
                if (data.feedback) {
                    const parsed = parseFeedback(data.feedback, userAnswer);
                    explanation = parsed.explanation;
                    user = parsed.user;
                    correct = parsed.correct;
                    score = parsed.score;
                }
                state.history_bilingual.push({
                    vi: state.currentVi,
                    en: user,
                    correct: correct,
                    score: score
                });
                renderTranslateHistory(state.history_bilingual);
                // L√†m n·ªïi b·∫≠t v√† xu·ªëng d√≤ng c√°c ph·∫ßn n·∫±m trong **...** v√† s·ªë th·ª© t·ª± 1., 2., ...
                let formatted = explanation || '';
                if (formatted) {
                    // Thay **...** th√†nh <span class='highlight'>...</span>
                    formatted = formatted.replace(/\*\*(.+?)\*\*/g, function(match, p1) {
                        return '<span class="highlight">' + p1 + '</span>';
                    });
                    // L√†m n·ªïi b·∫≠t s·ªë th·ª© t·ª± ƒë·∫ßu d√≤ng (1., 2., ...)
                    formatted = formatted.replace(/(\n|^)(\d+\.)/g, function(match, p1, p2) {
                        return '<br><span class="highlight">' + p2 + '</span>';
                    });
                    // T·ª± ƒë·ªông xu·ªëng d√≤ng tr∆∞·ªõc m·ªói ƒëo·∫°n highlight (n·∫øu c·∫ßn)
                    formatted = formatted.replace(/(<span class=\"highlight\">.+?<\/span>)/g, '<br>$1');
                    // Lo·∫°i b·ªè <br> ƒë·∫ßu n·∫øu c√≥
                    formatted = formatted.replace(/^<br>/, '');
                }
                feedbackDiv.innerHTML = formatted || '<span style="color:#ef4444;">Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi.</span>';
            } catch (e) {
                feedbackDiv.innerHTML = '<span style="color:#ef4444;">L·ªói k·∫øt n·ªëi, vui l√≤ng th·ª≠ l·∫°i.</span>';
            }
        };

        // H√†m render l·ªãch s·ª≠ d·ªãch song ng·ªØ
        function renderTranslateHistory(history) {
            const box = document.getElementById('translate-history-list');
            if (!history || history.length === 0) {
                box.innerHTML = '<i>Ch∆∞a c√≥ l·ªãch s·ª≠.</i>';
                return;
            }
            let html = '';
            for (let i = history.length - 1; i >= 0; i--) {
                let scoreDisplay = (typeof history[i].score !== 'undefined' && history[i].score !== '') ? history[i].score : '-';
                let correctDisplay = (typeof history[i].correct !== 'undefined' && history[i].correct !== '') ? history[i].correct : '-';
                html += `<div style='margin-bottom:10px;padding:8px 10px;background:#fff;border-radius:7px;box-shadow:0 1px 4px #ede9fe22;'>` +
                    `<div style='color:#7c3aed;font-weight:600;font-size:1.01em;'>${history.length - i}. ${history[i].vi}</div>` +
                    `<div style='color:#2563eb;font-weight:500;margin-top:2px;'>B·∫°n: ${history[i].en}</div>` +
                    `<div style='color:#059669;font-weight:500;margin-top:2px;'>ƒê√∫ng: ${correctDisplay}</div>` +
                    `<div style='color:#d97706;font-weight:500;margin-top:2px;'>‚≠ê ƒêi·ªÉm: ${scoreDisplay}</div>` +
                `</div>`;
            }
            box.innerHTML = html;
        }

        // N√∫t C√¢u ti·∫øp theo: l·∫•y c√¢u m·ªõi t·ª´ backend
        document.getElementById('next-vi-btn').onclick = async function() {
            const state = window.translateState;
            if (!state || !state.topic || !state.level) return;
            document.getElementById('vi-sentence-box').textContent = 'ƒêang l·∫•y c√¢u...';
            document.getElementById('hint-popup').style.display = 'none';
            document.getElementById('en-answer-input').value = '';
            document.getElementById('translate-feedback').textContent = '';
            document.getElementById('translate-next-box').textContent = '';
            try {
                // G·ª≠i to√†n b·ªô ƒëo·∫°n ƒë√£ d·ªãch (song ng·ªØ) l√™n backend ƒë·ªÉ AI sinh c√¢u m·ªõi n·ªëi ti·∫øp
                const bilingualHistory = state.history_bilingual || [];
                const paragraph = bilingualHistory.map(item => ({vi: item.vi, en: item.en}));
                const res = await fetch('http://127.0.0.1:8000/translate/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: state.topic, level: state.level, prev_history: state.history, paragraph })
                });
                const data = await res.json();
                document.getElementById('vi-sentence-box').textContent = data.vi_sentence;
                // L∆∞u l·∫°i c√¢u m·ªõi v√†o state
                state.currentVi = data.vi_sentence;
                state.history.push(data.vi_sentence);
                document.getElementById('hint-popup').style.display = 'none';

                // T·∫°o ƒëo·∫°n Vietsub v√† Engsub
                let vietArr = bilingualHistory.map(item => item.vi).filter(Boolean);
                let engArr = bilingualHistory.map(item => item.correct).filter(Boolean);
                let vietsub = vietArr.join('. ') + (vietArr.length ? '.' : '');
                let engsub = engArr.join('. ') + (engArr.length ? '.' : '');
                // Hi·ªÉn th·ªã l√™n giao di·ªán (ch·ªâ c·∫≠p nh·∫≠t n·ªôi dung, kh√¥ng t·∫°o l·∫°i div)
                let html = '';
                html += `<div style='font-weight:700;color:#7c3aed;margin-bottom:6px;'>Vietsub</div>`;
                html += `<div style='color:#222;margin-bottom:10px;'>${vietsub || '<i>Ch∆∞a c√≥ c√¢u n√†o.</i>'}</div>`;
                html += `<div style='font-weight:700;color:#2563eb;margin-bottom:6px;'>Engsub</div>`;
                html += `<div style='color:#2563eb;'>${engsub || '<i>Ch∆∞a c√≥ c√¢u n√†o.</i>'}</div>`;
                let paraDiv = document.getElementById('paragraph-view');
                if (paraDiv) paraDiv.innerHTML = html;
            } catch (e) {
                document.getElementById('vi-sentence-box').textContent = 'L·ªói l·∫•y c√¢u, vui l√≤ng th·ª≠ l·∫°i.';
            }
        };
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const homePage = document.getElementById('home-page');
        const chatContainer = document.getElementById('chat-container');
        const homeBtn = document.getElementById('home-btn');
        const practiceGrammarBtn = document.getElementById('practice-grammar-btn');

        // S·ª± ki·ªán cho n√∫t Trang ch·ªß
        homeBtn.onclick = function() {
            // Hi·ªán trang ch·ªß, ·∫©n c√°c ph·∫ßn kh√°c
            homePage.style.display = 'block';
            chatContainer.style.display = 'none';
            document.getElementById('translate-container').style.display = 'none';
            // ·∫®n modal n·∫øu ƒëang m·ªü
            document.getElementById('translate-modal').style.display = 'none';
            // ·∫®n popup g·ª£i √Ω n·∫øu ƒëang m·ªü
            document.getElementById('hint-popup').style.display = 'none';
        };

        // S·ª± ki·ªán cho n√∫t Luy·ªán t·∫≠p s·ª≠a ng·ªØ ph√°p
        practiceGrammarBtn.onclick = function() {
            homePage.style.display = 'none';
            chatContainer.style.display = 'block';
            document.getElementById('translate-container').style.display = 'none';
            document.getElementById('translate-modal').style.display = 'none';
            document.getElementById('hint-popup').style.display = 'none';
        };

        function appendMessage(text, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg ' + sender;
            let html = '';
            if (sender === 'user') {
                html = '<span class="icon">üßë‚Äçüéì</span><div class="bubble">' + text + '</div>';
            } else {
                // T·ª± ƒë·ªông xu·ªëng d√≤ng v·ªõi c√°c d·∫•u g·∫°ch ƒë·∫ßu d√≤ng ho·∫∑c s·ªë th·ª© t·ª±
                let formatted = text.replace(/\n/g, '<br>');
                formatted = formatted.replace(/(- |‚Ä¢ |\d+\. )/g, '<br><b>$1</b>');
                html = '<span class="icon">ü§ñ</span><div class="bubble">' + formatted + '</div>';
            }
            msgDiv.innerHTML = html;
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        sendBtn.onclick = async function() {
            const text = userInput.value.trim();
            if (!text) return;
            appendMessage(text, 'user');
            userInput.value = '';
            appendMessage('...', 'ai');
            try {
                const res = await fetch('http://127.0.0.1:8000/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                const data = await res.json();
                // X√≥a d·∫•u "..." cu·ªëi c√πng
                messagesDiv.removeChild(messagesDiv.lastChild);
                appendMessage(data.reply, 'ai');
            } catch (e) {
                messagesDiv.removeChild(messagesDiv.lastChild);
                appendMessage('Error contacting AI.', 'ai');
            }
        };

        userInput.addEventListener('keydown', function(e) {
            if (e.key === 'Enter') sendBtn.click();
        });

        // N√∫t ƒë√≥ng popup g·ª£i √Ω
        document.getElementById('close-hint-btn').onclick = function() {
            document.getElementById('hint-popup').style.display = 'none';
        };
        // ƒê√≥ng popup g·ª£i √Ω khi click ra ngo√†i
        document.addEventListener('mousedown', function(event) {
            const hintPopup = document.getElementById('hint-popup');
            const showHintBtn = document.getElementById('show-hint-btn');
            if (!hintPopup || hintPopup.style.display === 'none') return;
            if (!hintPopup.contains(event.target) && !showHintBtn.contains(event.target)) {
                hintPopup.style.display = 'none';
            }
        });
        // Sidebar navigation logic
        document.getElementById('show-hint-btn').onclick = function() {
            const state = window.translateState;
            let vi = state && state.currentVi ? state.currentVi : '';
            let hintContent = document.getElementById('hint-content');
            if (!vi) {
                hintContent.innerHTML = '<i>Kh√¥ng c√≥ c√¢u ƒë·ªÉ g·ª£i √Ω.</i>';
                document.getElementById('hint-popup').style.display = 'block';
                return;
            }
            hintContent.innerHTML = '<span style="color:#7c3aed;">ƒêang l·∫•y g·ª£i √Ω...</span>';
            document.getElementById('hint-popup').style.display = 'block';
            fetch('http://127.0.0.1:8000/translate/hint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ vi_sentence: vi })
            })
            .then(res => res.json())
            .then(data => {
                if (!data || !data.hints || !Array.isArray(data.hints) || data.hints.length === 0) {
                    hintContent.innerHTML = '<i>Kh√¥ng c√≥ g·ª£i √Ω ƒë·∫∑c bi·ªát cho c√¢u n√†y.</i>';
                    return;
                }
                let html = '<ul style="padding-left:18px;margin:0;">';
                for (const h of data.hints) {
                    if (h.word) {
                        html += `<li><b>${h.word}</b> <span style='color:#666;font-size:0.98em;margin-left:6px;'>${h.vi}</span></li>`;
                    } else if (h.grammar) {
                        html += `<li><b>${h.grammar}</b> <span style='color:#666;font-size:0.98em;margin-left:6px;'>${h.vi}</span></li>`;
                    } else if (h.info) {
                        html += `<li style='color:#888;'>${h.info}</li>`;
                    }
                }
                html += '</ul>';
                hintContent.innerHTML = html;
            })
            .catch(() => {
                hintContent.innerHTML = '<span style="color:#ef4444;">L·ªói l·∫•y g·ª£i √Ω t·ª´ server.</span>';
            });
        };
        // ·∫®n/hi·ªán sidebar khi nh·∫•n v√†o sidebar-toggle
        const sidebarEl = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarOpenBtn = document.getElementById('sidebar-open-btn');

        sidebarToggle.onclick = function() {
            // Toggle class ƒë·ªÉ ·∫©n/hi·ªán sidebar
            if (!sidebarEl.classList.contains('sidebar-collapsed')) {
                sidebarEl.classList.add('sidebar-collapsed');
                sidebarOpenBtn.style.display = 'flex';
            } else {
                sidebarEl.classList.remove('sidebar-collapsed');
                sidebarOpenBtn.style.display = 'none';
            }
        };

        // N√∫t m·ªü l·∫°i sidebar
        sidebarOpenBtn.onclick = function() {
            sidebarEl.classList.remove('sidebar-collapsed');
            sidebarOpenBtn.style.display = 'none';
        };
    </script>
    <style>
.highlight {
    background: #fffbe6;
    color: #d97706;
    font-weight: bold;
    padding: 1px 5px;
    border-radius: 5px;
    box-shadow: 0 1px 4px #fde68a55;
}
</style>
</body>
</html>

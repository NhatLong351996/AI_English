<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>English Chat AI</title>
    <link rel="stylesheet" href="/static/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@800&display=swap" rel="stylesheet">
</head>

<body>
    <!-- N√∫t scroll l√™n ƒë·∫ßu trang -->
    <button id="scroll-top-btn"
        style="position:fixed;right:32px;bottom:32px;z-index:9999;background:#7c3aed;border:none;border-radius:50%;width:48px;height:48px;box-shadow:0 4px 16px #7c3aed33;display:none;align-items:center;justify-content:center;cursor:pointer;transition:opacity 0.18s;">
        <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24">
            <path fill="#fff" d="M12 4l-8 8h6v8h4v-8h6z" />
        </svg>
    </button>
    <nav id="sidebar">
        <!-- N√∫t m·ªü l·∫°i sidebar khi ƒë√£ ƒë√≥ng -->
        <button id="sidebar-open-btn"
            style="display:none;position:fixed;top:22px;left:10px;z-index:1001;background:#ede9fe;color:#7c3aed;border:none;border-radius:50%;width:38px;height:38px;box-shadow:0 2px 8px #ede9fe;align-items:center;justify-content:center;cursor:pointer;padding:0;">
            <svg viewBox="0 0 48 48" width="28" height="28">
                <g id="cat-head">
                    <ellipse cx="24" cy="28" rx="12" ry="10" fill="#7c3aed" />
                    <ellipse cx="15" cy="16" rx="4" ry="6" fill="#7c3aed" transform="rotate(-20 15 16)" />
                    <ellipse cx="33" cy="16" rx="4" ry="6" fill="#7c3aed" transform="rotate(20 33 16)" />
                    <ellipse cx="20" cy="30" rx="2.5" ry="1.2" fill="#fff" />
                    <ellipse cx="28" cy="30" rx="2.5" ry="1.2" fill="#fff" />
                    <ellipse cx="20" cy="28" rx="1.2" ry="1.2" fill="#222" />
                    <ellipse cx="28" cy="28" rx="1.2" ry="1.2" fill="#222" />
                    <ellipse cx="24" cy="34" rx="2.5" ry="1.2" fill="#fff" />
                </g>
            </svg>
        </button>
        <div class="sidebar-toggle" id="sidebar-toggle" title="·∫®n/hi·ªán thanh ch·ª©c nƒÉng">
            <span id="sidebar-cat" style="display:block;width:28px;height:28px;">
                <svg viewBox="0 0 48 48" width="28" height="28">
                    <g id="cat-head">
                        <ellipse cx="24" cy="28" rx="12" ry="10" fill="#7c3aed" />
                        <ellipse cx="15" cy="16" rx="4" ry="6" fill="#7c3aed" transform="rotate(-20 15 16)" />
                        <ellipse cx="33" cy="16" rx="4" ry="6" fill="#7c3aed" transform="rotate(20 33 16)" />
                        <ellipse cx="20" cy="30" rx="2.5" ry="1.2" fill="#fff" />
                        <ellipse cx="28" cy="30" rx="2.5" ry="1.2" fill="#fff" />
                        <ellipse cx="20" cy="28" rx="1.2" ry="1.2" fill="#222" />
                        <ellipse cx="28" cy="28" rx="1.2" ry="1.2" fill="#222" />
                        <ellipse cx="24" cy="34" rx="2.5" ry="1.2" fill="#fff" />
                    </g>
                </svg>
            </span>
        </div>
        <div class="logo-enhanced">
            <span class="logo-icon">üê±</span>
            <span class="logo-text">English AI</span>
        </div>
        <div class="sidebar-section-title">
            <span class="section-icon">‚ú®</span>
            <span class="section-text">Ch·ª©c nƒÉng</span>
        </div>
        <button class="sidebar-btn" id="home-btn"><span style="font-size:1.3rem;margin-right:7px;">üè°</span>Trang
            ch·ªß</button>
        <button class="sidebar-btn" id="practice-grammar-btn"><span
                style="font-size:1.3rem;margin-right:7px;">‚úèÔ∏è</span>Luy·ªán t·∫≠p s·ª≠a ng·ªØ ph√°p</button>
        <button class="sidebar-btn" id="practice-translate-btn"><span
                style="font-size:1.3rem;margin-right:7px;">üåè</span>Luy·ªán d·ªãch ch·ªß ƒë·ªÅ</button>
        <button class="sidebar-btn" id="vocab-btn"><span style="font-size:1.3rem;margin-right:7px;">üìö</span>Luy·ªán t·ª´
            v·ª±ng</button>
        <button class="sidebar-btn" id="quiz-btn"><span style="font-size:1.3rem;margin-right:7px;">üìù</span>B√†i
            Quiz</button>
        <button class="sidebar-btn" id="listening-btn"><span style="font-size:1.3rem;margin-right:7px;">üéß</span>Luy·ªán
            nghe</button>
        <!-- Modal Quiz (·∫©n m·∫∑c ƒë·ªãnh) -->
        <div id="quiz-modal" class="modal" style="display:none;">
            <div class="modal-content quiz-modal-center">
                <div class="modal-title-topic-box">
                    <span class="modal-title-icon">üìù</span>
                    <span class="modal-title-topic-text">B·∫Øt ƒë·∫ßu b√†i Quiz</span>
                </div>
                <div style="margin-bottom:16px;">
                    <label for="quiz-topic-select">Ch·ªß ƒë·ªÅ Quiz:</label>
                    <select id="quiz-topic-select">
                        <option value="grammar">Ng·ªØ ph√°p</option>
                        <option value="vocabulary">T·ª´ v·ª±ng</option>
                        <option value="reading">ƒê·ªçc hi·ªÉu</option>
                    </select>
                </div>
                <div style="margin-bottom:18px;">
                    <label for="quiz-level-select">M·ª©c ƒë·ªô:</label>
                    <select id="quiz-level-select">
                        <option value="1.0">Band 1.0</option>
                        <option value="2.0">Band 2.0</option>
                        <option value="3.0">Band 3.0</option>
                        <option value="3.5">Band 3.5</option>
                        <option value="4.0">Band 4.0</option>
                        <option value="4.5">Band 4.5</option>
                        <option value="5.0">Band 5.0</option>
                        <option value="5.5">Band 5.5</option>
                        <option value="6.0">Band 6.0</option>
                        <option value="6.5">Band 6.5</option>
                        <option value="7.0">Band 7.0</option>
                        <option value="7.5">Band 7.5</option>
                        <option value="8.0">Band 8.0</option>
                        <option value="8.5">Band 8.5</option>
                        <option value="9.0">Band 9.0</option>
                    </select>
                </div>
                <button id="start-quiz-btn" style="margin-right:10px;">B·∫Øt ƒë·∫ßu</button>
                <button id="close-quiz-modal">H·ªßy</button>
            </div>
        </div>
        <!-- C√≥ th·ªÉ th√™m c√°c ch·ª©c nƒÉng kh√°c ·ªü ƒë√¢y -->
        <!-- Modal ch·ªçn ch·ªß ƒë·ªÅ v√† m·ª©c ƒë·ªô -->
        <div id="translate-modal" class="modal" style="display:none;">
            <div class="modal-content">
                <div class="modal-title-topic-box">
                    <span class="modal-title-icon">üìù</span>
                    <span class="modal-title-topic-text">Ch·ªçn ch·ªß ƒë·ªÅ & m·ª©c ƒë·ªô</span>
                </div>
                <div style="margin-bottom:12px;">
                    <div class="topic-radio-group-enhanced">
                        <label class="topic-radio-label-enhanced">
                            <input type="radio" name="topic-mode" id="topic-mode-select" value="select" checked>
                            <span class="radio-custom-enhanced">üéØ</span>
                            <span class="radio-title">Ch·ªß ƒë·ªÅ c√≥ s·∫µn</span>
                            <span class="radio-desc">(Ch·ªçn t·ª´ danh s√°ch c√°c ch·ªß ƒë·ªÅ ph·ªï bi·∫øn)</span>
                        </label>
                        <label class="topic-radio-label-enhanced">
                            <input type="radio" name="topic-mode" id="topic-mode-custom" value="custom">
                            <span class="radio-custom-enhanced">‚úèÔ∏è</span>
                            <span class="radio-title">T·ª± nh·∫≠p ch·ªß ƒë·ªÅ</span>
                            <span class="radio-desc">(B·∫°n t·ª± g√µ ch·ªß ƒë·ªÅ mu·ªën luy·ªán d·ªãch)</span>
                        </label>
                    </div>
                    <div id="topic-select-box">
                        <label for="topic-select">Ch·ªß ƒë·ªÅ:</label>
                        <select id="topic-select">
                            <option value="travel">Du l·ªãch</option>
                            <option value="school">H·ªçc t·∫≠p</option>
                            <option value="work">C√¥ng vi·ªác</option>
                            <option value="family">Gia ƒë√¨nh</option>
                            <option value="food">·∫®m th·ª±c</option>
                        </select>
                    </div>
                    <div id="custom-topic-box" style="display:none;margin-top:8px;">
                        <label for="custom-topic-input" style="color:#7c3aed;font-weight:500;">Nh·∫≠p ch·ªß ƒë·ªÅ b·∫°n
                            mu·ªën:</label>
                        <input id="custom-topic-input" type="text" placeholder="V√≠ d·ª•: C√¥ng ngh·ªá, S·ª©c kh·ªèe, ..."
                            style="margin-top:6px;width:92%;padding:8px 12px;border-radius:8px;border:1.5px solid #a78bfa;font-size:1.08rem;outline:none;box-shadow:0 1.5px 8px #ede9fe33;transition:border 0.18s;" />
                    </div>
                </div>
                <div style="margin-bottom:18px;">
                    <label for="level-select">M·ª©c ƒë·ªô:</label>
                    <select id="level-select">
                        <option value="1.0">Band 1.0</option>
                        <option value="2.0">Band 2.0</option>
                        <option value="3.0">Band 3.0</option>
                        <option value="3.5">Band 3.5</option>
                        <option value="4.0">Band 4.0</option>
                        <option value="4.5">Band 4.5</option>
                        <option value="5.0">Band 5.0</option>
                        <option value="5.5">Band 5.5</option>
                        <option value="6.0">Band 6.0</option>
                        <option value="6.5">Band 6.5</option>
                        <option value="7.0">Band 7.0</option>
                        <option value="7.5">Band 7.5</option>
                        <option value="8.0">Band 8.0</option>
                        <option value="8.5">Band 8.5</option>
                        <option value="9.0">Band 9.0</option>
                    </select>
                </div>
                <button id="start-translate-btn" style="margin-right:10px;">B·∫Øt ƒë·∫ßu</button>
                <button id="close-translate-modal">H·ªßy</button>
            </div>
        </div>
    </nav>
    <div style="flex:1;display:flex;flex-direction:column;">
        <header>
            <span>üí¨</span> English Chat AI
            <div class="header-slogan">Luy·ªán d·ªãch & s·ª≠a ng·ªØ ph√°p ti·∫øng Anh th√¥ng minh</div>
        </header>
        <div id="main-content" style="flex:1;">
            <!-- Giao di·ªán luy·ªán nghe -->
            <div id="listening-container"
                style="display:none;max-width:520px;margin:32px auto 0 auto;padding:24px 12px;background:#f8fafc;border-radius:14px;box-shadow:0 2px 12px #ede9fe33;">
                <h2 style="text-align:center;color:#7c3aed;margin-bottom:18px;">Luy·ªán nghe ti·∫øng Anh</h2>
                <div style="margin-bottom:18px;">
                    <label for="listening-topic-select">Ch·ªß ƒë·ªÅ:</label>
                    <select id="listening-topic-select">
                        <option value="daily">Giao ti·∫øp h√†ng ng√†y</option>
                        <option value="school">Tr∆∞·ªùng h·ªçc</option>
                        <option value="travel">Du l·ªãch</option>
                        <option value="work">C√¥ng vi·ªác</option>
                    </select>
                    <label for="listening-band-select" style="margin-left:18px;">Band ƒëi·ªÉm IELTS:</label>
                    <select id="listening-band-select">
                        <option value="1.0">Band 1.0</option>
                        <option value="2.0">Band 2.0</option>
                        <option value="3.0">Band 3.0</option>
                        <option value="3.5">Band 3.5</option>
                        <option value="4.0">Band 4.0</option>
                        <option value="4.5">Band 4.5</option>
                        <option value="5.0">Band 5.0</option>
                        <option value="5.5">Band 5.5</option>
                        <option value="6.0">Band 6.0</option>
                        <option value="6.5">Band 6.5</option>
                        <option value="7.0">Band 7.0</option>
                        <option value="7.5">Band 7.5</option>
                        <option value="8.0">Band 8.0</option>
                        <option value="8.5">Band 8.5</option>
                        <option value="9.0">Band 9.0</option>
                    </select>
                    <button id="start-listening-btn" style="margin-left:18px;">B·∫Øt ƒë·∫ßu</button>
                </div>
                <div id="listening-question-box" style="margin-bottom:18px;"></div>
                <div id="listening-audio-box" style="margin-bottom:18px;"></div>
                <input id="listening-answer-input" type="text" placeholder="Nh·∫≠p ƒë√°p √°n b·∫°n nghe ƒë∆∞·ª£c..."
                    style="width:100%;padding:8px 12px;border-radius:8px;border:1.5px solid #a78bfa;font-size:1.08rem;outline:none;box-shadow:0 1.5px 8px #ede9fe33;transition:border 0.18s;margin-bottom:12px;" />
                <button id="check-listening-btn"
                    style="padding:7px 18px;border-radius:7px;background:linear-gradient(90deg,#a78bfa 0%,#7c3aed 100%);color:#fff;font-weight:600;border:none;">Ki·ªÉm
                    tra ƒë√°p √°n</button>
                <div id="listening-feedback" style="min-height:32px;margin-top:12px;font-size:1.08em;"></div>
            </div>
            <div id="vocab-container"
                style="display:none;max-width:420px;margin:32px auto 0 auto;padding:24px 12px;background:#f8fafc;border-radius:14px;box-shadow:0 2px 12px #ede9fe33;">
                <h2 style="text-align:center;color:#7c3aed;margin-bottom:18px;">Luy·ªán t·ª´ v·ª±ng (Flashcard)</h2>
                <div id="vocab-flashcard" class="flip-card" style="margin-bottom:18px;">
                    <div class="flip-card-inner" id="vocab-flip-inner">
                        <div class="flip-card-front">
                            <div
                                style="display:flex;align-items:center;justify-content:center;margin-bottom:10px;gap:10px;min-height:56px;">
                                <span id="vocab-word"
                                    style="font-size:2.1em;font-weight:800;color:#2563eb;line-height:1.1;vertical-align:middle;display:inline-block;text-shadow:0 2px 8px #ede9fe77;">
                                </span>
                                <button id="vocab-speak-btn"
                                    style="background:none;border:none;cursor:pointer;padding:0;margin:0;vertical-align:middle;display:inline-flex;align-items:center;transition:transform 0.18s;"
                                    title="Nghe ph√°t √¢m" onmouseover="this.style.transform='scale(1.18)'"
                                    onmouseout="this.style.transform='scale(1)'">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="30" height="30" viewBox="0 0 24 24"
                                        style="vertical-align:middle;">
                                        <path fill="#3b82f6"
                                            d="M3 10v4h4l5 5V5L7 10H3zm13.5 2c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03zm2.5 0c0 3.04-1.64 5.64-4.5 6.32v-2.02c2.01-.45 3.5-2.24 3.5-4.3s-1.49-3.85-3.5-4.3V5.68c2.86.68 4.5 3.28 4.5 6.32z" />
                                    </svg>
                                </button>
                            </div>
                            <button id="show-meaning-btn"
                                style="background:#ede9fe;color:#7c3aed;border:none;border-radius:7px;padding:6px 18px;font-weight:600;cursor:pointer;">Hi·ªán
                                nghƒ©a</button>
                        </div>
                        <div class="flip-card-back">
                            <img id="vocab-image-back"
                                style="display:none;margin:0 auto 10px auto;max-width:90px;max-height:90px;border-radius:12px;box-shadow:0 2px 8px #ede9fe55;" />
                            <div id="vocab-meaning" style="font-size:1.08em;color:#059669;margin-bottom:10px;"></div>
                            <div id="vocab-phonetic" style="font-size:1em;color:#7c3aed;"></div>
                            <button id="flip-back-btn"
                                style="margin-top:12px;background:#ede9fe;color:#7c3aed;border:none;border-radius:7px;padding:6px 18px;font-weight:600;cursor:pointer;">L·∫≠t
                                l·∫°i</button>
                        </div>
                    </div>
                </div>
                <div id="vocab-nav-btns" style="display:flex;gap:12px;justify-content:center;margin-bottom:18px;">
                    <button id="prev-vocab-btn"
                        style="padding:7px 18px;border-radius:7px;background:#ede9fe;color:#7c3aed;font-weight:600;border:none;">Quay
                        l·∫°i</button>
                    <button id="next-vocab-btn"
                        style="padding:7px 18px;border-radius:7px;background:linear-gradient(90deg,#a78bfa 0%,#7c3aed 100%);color:#fff;font-weight:600;border:none;">Ti·∫øp
                        theo</button>
                </div>
                <div style="text-align:center;margin-bottom:18px;color:#7c3aed;font-size:0.98em;">
                    <span id="vocab-progress"></span>
                </div>
                <div style="background:#f3f4f6;padding:14px 10px;border-radius:10px;margin-bottom:18px;">
                    <h3 style="color:#7c3aed;font-size:1.08em;margin-bottom:8px;">Th√™m t·ª´ m·ªõi</h3>
                    <form id="add-vocab-form" style="display:flex;flex-direction:column;gap:8px;">
                        <input id="vocab-input-word" type="text" placeholder="T·ª´ ti·∫øng Anh" required
                            style="padding:7px 10px;border-radius:7px;border:1px solid #a78bfa;" />
                        <input id="vocab-input-meaning" type="text" placeholder="Nghƒ©a ti·∫øng Vi·ªát" required
                            style="padding:7px 10px;border-radius:7px;border:1px solid #a78bfa;" />
                        <input id="vocab-input-phonetic" type="text" placeholder="Phi√™n √¢m (t√πy ch·ªçn)"
                            style="padding:7px 10px;border-radius:7px;border:1px solid #a78bfa;" />
                        <button type="submit"
                            style="padding:7px 18px;border-radius:7px;background:#ede9fe;color:#7c3aed;font-weight:600;border:none;">Th√™m
                            t·ª´</button>
                    </form>
                    <div id="add-vocab-msg" style="color:#059669;margin-top:8px;font-size:0.98em;"></div>
                </div>
            </div>
            <div id="home-page" style="display:block;padding:40px 24px;text-align:center;">
                <h2>Ch√†o m·ª´ng ƒë·∫øn v·ªõi English Chat AI!</h2>
                <p>Ch·ªçn ch·ª©c nƒÉng luy·ªán t·∫≠p ·ªü thanh b√™n tr√°i ƒë·ªÉ b·∫Øt ƒë·∫ßu.</p>
                <img src="https://cdn-icons-png.flaticon.com/512/3135/3135715.png" alt="Welcome"
                    style="width:120px;margin-top:20px;opacity:0.8;">
            </div>
            <!-- Giao di·ªán l√†m quiz -->
            <div id="quiz-container"
                style="display:none;max-width:520px;margin:32px auto 0 auto;padding:24px 12px;background:#f8fafc;border-radius:14px;box-shadow:0 2px 12px #ede9fe33;">
                <div id="quiz-progress" style="margin-bottom:18px;font-weight:600;color:#7c3aed;"></div>
                <div id="quiz-question-box" style="font-size:1.15em;font-weight:600;margin-bottom:18px;color:#222;">
                </div>
                <form id="quiz-answers-form" style="margin-bottom:18px;"></form>
                <div style="display:flex;gap:12px;justify-content:flex-end;">
                    <button id="quiz-next-btn"
                        style="display:none;padding:7px 18px;border-radius:7px;background:#ede9fe;color:#7c3aed;font-weight:600;border:none;">C√¢u
                        ti·∫øp theo</button>
                    <button id="quiz-submit-btn"
                        style="display:none;padding:7px 18px;border-radius:7px;background:linear-gradient(90deg,#a78bfa 0%,#7c3aed 100%);color:#fff;font-weight:600;border:none;">N·ªôp
                        b√†i</button>
                </div>
                <div id="quiz-result-box" style="margin-top:18px;"></div>
            </div>
            <div id="chat-container" style="display:none;">
                <h2 style="display:none;">English Chat AI</h2>
                <div id="messages"></div>
                <div id="input-area">
                    <input type="text" id="user-input" placeholder="Type your English sentence..." />
                    <button id="send-btn">Send</button>
                </div>
            </div>
            <!-- Giao di·ªán luy·ªán d·ªãch ch·ªß ƒë·ªÅ -->
            <div id="translate-container"
                style="display:none;padding:32px 12px;max-width:520px;margin:0 auto;position:relative;">
                <div id="translate-info" class="translate-info-box translate-info-fixed"></div>
                <h2
                    style="text-align:center;margin-bottom:18px;display:flex;align-items:center;justify-content:center;gap:10px;">
                    <span class="cute-anim-icon"
                        style="display:inline-block;animation:bounce 1.2s infinite alternate cubic-bezier(.5,1.5,.5,1);font-size:1.6em;">üêæ</span>
                    Luy·ªán d·ªãch theo ch·ªß ƒë·ªÅ
                </h2>
                <style>
                    @keyframes bounce {
                        0% {
                            transform: translateY(0);
                        }

                        100% {
                            transform: translateY(-12px) scale(1.15);
                        }
                    }

                    .cute-anim-icon {
                        will-change: transform;
                        filter: drop-shadow(0 2px 6px #ede9fe);
                    }
                </style>
                <div
                    style="display:flex;align-items:center;justify-content:center;margin-bottom:18px;gap:10px;position:relative;">
                    <div id="vi-sentence-box"
                        style="background:#ede9fe;border-radius:10px;padding:18px 14px;font-size:1.13rem;color:#5b21b6;min-height:32px;text-align:center;font-weight:500;">
                    </div>
                    <button id="show-hint-btn"
                        style="background:#fff;border:1.5px solid #a78bfa;color:#7c3aed;border-radius:50%;width:38px;height:38px;box-shadow:0 2px 8px #ede9fe;display:flex;align-items:center;justify-content:center;cursor:pointer;"
                        title="Xem g·ª£i √Ω d·ªãch">
                        <span style="font-size:1.3em;">üí°</span>
                    </button>
                    <div id="hint-popup"
                        style="display:none;position:absolute;left:110%;top:0;background:#fff;border:1.5px solid #a78bfa;border-radius:12px;box-shadow:0 4px 16px #ede9fe;padding:18px 20px;z-index:1002;min-width:260px;max-width:90vw;">
                        <div style="font-weight:600;color:#7c3aed;margin-bottom:8px;font-size:1.08em;">G·ª£i √Ω t·ª´ v·ª±ng &
                            c·∫•u tr√∫c</div>
                        <div id="hint-content" style="color:#333;font-size:1.04em;"></div>
                        <button id="close-hint-btn"
                            style="margin-top:10px;background:#ede9fe;color:#7c3aed;border:none;border-radius:7px;padding:5px 16px;font-weight:500;cursor:pointer;">ƒê√≥ng</button>
                    </div>
                </div>
                <div style="display:flex;gap:8px;align-items:center;margin-bottom:10px;">
                    <input type="text" id="en-answer-input" placeholder="Nh·∫≠p c√¢u ti·∫øng Anh c·ªßa b·∫°n..."
                        style="flex:1;font-size:1rem;padding:7px 10px;border-radius:7px;border:1px solid #a78bfa;" />
                    <button id="send-translate-btn"
                        style="font-size:1rem;padding:7px 18px;border-radius:7px;background:linear-gradient(90deg,#a78bfa 0%,#7c3aed 100%);color:#fff;font-weight:600;border:none;">G·ª≠i</button>
                    <button id="next-vi-btn"
                        style="font-size:1rem;padding:7px 14px;border-radius:7px;background:#e1f5fe;color:#7c3aed;font-weight:600;border:none;">C√¢u
                        ti·∫øp theo</button>
                </div>
                <div id="translate-feedback" style="min-height:40px;margin-bottom:10px;"></div>
                <div id="translate-next-box" style="color:#7c3aed;font-size:0.98rem;text-align:center;"></div>
                <div style="display:flex;gap:18px;margin-top:18px;align-items:flex-start;">
                    <div id="paragraph-view"
                        style="flex:1;min-width:0;padding:12px 10px;background:#f3f4f6;border-radius:8px;"></div>
                    <div id="translate-history-list" style="flex:1;min-width:0;"></div>
                </div>
            </div>
        </div>
        <footer>
            ¬© 2025 English Chat AI | Powered by Azure OpenAI & FastAPI
        </footer>
    </div>
    <script>
        // H√†m ·∫©n t·∫•t c·∫£ container ch·ª©c nƒÉng
        function hideAllContainers() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('chat-container').style.display = 'none';
            document.getElementById('translate-container').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('vocab-container').style.display = 'none';
            document.getElementById('listening-container').style.display = 'none';
            document.getElementById('quiz-modal').style.display = 'none';
            document.getElementById('translate-modal').style.display = 'none';
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
        }

        // S·ª± ki·ªán cho sidebar
        document.getElementById('home-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('home-page').style.display = 'block';
        };
        document.getElementById('practice-grammar-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('chat-container').style.display = 'block';
        };
        document.getElementById('practice-translate-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('translate-modal').style.display = 'block';
        };
        document.getElementById('vocab-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('vocab-container').style.display = 'block';
        };
        document.getElementById('quiz-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('quiz-modal').style.display = 'flex';
        };
        document.getElementById('listening-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('listening-container').style.display = 'block';
            document.getElementById('listening-question-box').textContent = '';
            document.getElementById('listening-audio-box').innerHTML = '';
            document.getElementById('listening-answer-input').value = '';
            document.getElementById('listening-feedback').textContent = '';
        };

        let currentListening = null;

        document.getElementById('start-listening-btn').onclick = async function () {
            const topic = document.getElementById('listening-topic-select').value;
            const band = document.getElementById('listening-band-select').value;
            document.getElementById('listening-question-box').textContent = 'ƒêang t·∫°o c√¢u h·ªèi luy·ªán nghe...';
            document.getElementById('listening-audio-box').innerHTML = '';
            document.getElementById('listening-answer-input').value = '';
            document.getElementById('listening-feedback').textContent = '';
            try {
                // G·ªçi API t·∫°o c√¢u h·ªèi luy·ªán nghe
                const resp = await fetch('http://127.0.0.1:8000/api/generate-listening', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, band })
                });
                if (!resp.ok) throw new Error('API l·ªói');
                const data = await resp.json();
                // data: {text: '...', answer: '...', audioUrl: '...'}
                currentListening = data;
                document.getElementById('listening-question-box').textContent = `Ch·ªß ƒë·ªÅ: ${topic}, Band: ${band}`;
                document.getElementById('listening-audio-box').innerHTML = `<button id='play-listening-audio' style='background:#7c3aed;color:#fff;border:none;border-radius:50%;width:48px;height:48px;display:inline-flex;align-items:center;justify-content:center;box-shadow:0 2px 8px #ede9fe33;cursor:pointer;'><svg xmlns='http://www.w3.org/2000/svg' width='28' height='28' viewBox='0 0 24 24'><path fill='#fff' d='M8 5v14l11-7z'/></svg></button>`;
                setTimeout(() => {
                    const playBtn = document.getElementById('play-listening-audio');
                    if (playBtn) {
                        playBtn.onclick = function () {
                            if (currentListening.audioUrl) {
                                const audio = new Audio(currentListening.audioUrl);
                                audio.play();
                            } else if ('speechSynthesis' in window && currentListening.text) {
                                const utter = new SpeechSynthesisUtterance(currentListening.text);
                                utter.lang = 'en-US';
                                window.speechSynthesis.speak(utter);
                            }
                        };
                    }
                }, 100);
            } catch (e) {
                document.getElementById('listening-question-box').textContent = 'L·ªói t·∫°o c√¢u h·ªèi luy·ªán nghe.';
            }
        };

        document.getElementById('check-listening-btn').onclick = function () {
            if (!currentListening) return;
            const userAns = document.getElementById('listening-answer-input').value.trim();
            if (!userAns) {
                document.getElementById('listening-feedback').textContent = 'B·∫°n c·∫ßn nh·∫≠p ƒë√°p √°n.';
                return;
            }
            // So s√°nh kh√¥ng ph√¢n bi·ªát d·∫•u c√¢u
            function normalize(str) {
                // Lo·∫°i b·ªè d·∫•u c√¢u, chu·∫©n h√≥a s·ªë, kho·∫£ng tr·∫Øng
                let s = str.toLowerCase().replace(/[.,!?;:]/g, '').replace(/\s+/g, ' ').trim();
                // Chuy·ªÉn ƒë·ªïi c√°c s·ªë th√†nh ch·ªØ (v√≠ d·ª•: 7 -> seven, 8 -> eight)
                s = s.replace(/\b0\b/g, 'zero')
                    .replace(/\b1\b/g, 'one')
                    .replace(/\b2\b/g, 'two')
                    .replace(/\b3\b/g, 'three')
                    .replace(/\b4\b/g, 'four')
                    .replace(/\b5\b/g, 'five')
                    .replace(/\b6\b/g, 'six')
                    .replace(/\b7\b/g, 'seven')
                    .replace(/\b8\b/g, 'eight')
                    .replace(/\b9\b/g, 'nine');
                // Chu·∫©n h√≥a a.m./am, p.m./pm
                s = s.replace(/a\.m\.|am/g, 'am').replace(/p\.m\.|pm/g, 'pm');
                return s;
            }
            if (normalize(userAns) === normalize(currentListening.answer || '')) {
                document.getElementById('listening-feedback').textContent = '‚úÖ Ch√≠nh x√°c!';
            } else {
                document.getElementById('listening-feedback').textContent = `‚ùå Sai. ƒê√°p √°n ƒë√∫ng: ${currentListening.answer || ''}`;
            }
        };
        // Hi·ªÉn th·ªã n√∫t scroll l√™n ƒë·∫ßu trang khi cu·ªôn xu·ªëng
        const scrollBtn = document.getElementById('scroll-top-btn');
        window.addEventListener('scroll', function () {
            if (window.scrollY > 180) {
                scrollBtn.style.display = 'flex';
                scrollBtn.style.opacity = '1';
            } else {
                scrollBtn.style.opacity = '0';
                setTimeout(() => { scrollBtn.style.display = 'none'; }, 180);
            }
        });
        scrollBtn.onclick = function () {
            window.scrollTo({ top: 0, behavior: 'smooth' });
        };
        // Khi click v√†o n√∫t Quiz, m·ªü modal Quiz
        document.getElementById('quiz-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('quiz-modal').style.display = 'flex';
        };
        document.getElementById('close-quiz-modal').onclick = function () {
            document.getElementById('quiz-modal').style.display = 'none';
        };
        // Luy·ªán d·ªãch ch·ªß ƒë·ªÅ: m·ªü modal ch·ªçn ch·ªß ƒë·ªÅ/m·ª©c ƒë·ªô
        document.getElementById('practice-translate-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('translate-modal').style.display = 'block';
            // ·∫®n t·∫°m box Ch·ªß ƒë·ªÅ | M·ª©c ƒë·ªô khi m·ªü modal
            document.getElementById('translate-info').style.visibility = 'hidden';
            // ·∫®n quiz n·∫øu ƒëang m·ªü
            document.getElementById('quiz-container').style.display = 'none';
        };
        document.getElementById('close-translate-modal').onclick = function () {
            document.getElementById('translate-modal').style.display = 'none';
            // Hi·ªán l·∫°i box Ch·ªß ƒë·ªÅ | M·ª©c ƒë·ªô n·∫øu c√≥ n·ªôi dung
            if (document.getElementById('translate-info').innerHTML.trim() !== '') {
                document.getElementById('translate-info').style.visibility = 'visible';
            }
        };
        // Chuy·ªÉn ƒë·ªïi gi·ªØa ch·ªçn ch·ªß ƒë·ªÅ c√≥ s·∫µn v√† t·ª± nh·∫≠p
        document.getElementById('topic-mode-select').onchange = function () {
            if (this.checked) {
                document.getElementById('topic-select-box').style.display = 'block';
                document.getElementById('custom-topic-box').style.display = 'none';
            }
        };
        document.getElementById('topic-mode-custom').onchange = function () {
            if (this.checked) {
                document.getElementById('topic-select-box').style.display = 'none';
                document.getElementById('custom-topic-box').style.display = 'block';
                document.getElementById('custom-topic-input').focus();
            }
        };
        document.getElementById('start-translate-btn').onclick = async function () {
            // Khi b·∫Øt ƒë·∫ßu ch·ªß ƒë·ªÅ m·ªõi, reset box
            document.getElementById('translate-info').style.visibility = 'visible';
            // ·∫®n modal, hi·ªÉn th·ªã giao di·ªán luy·ªán d·ªãch
            document.getElementById('translate-modal').style.display = 'none';
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('chat-container').style.display = 'none';
            document.getElementById('translate-container').style.display = 'block';
            // L·∫•y ch·ªß ƒë·ªÅ v√† m·ª©c ƒë·ªô
            let topic = '';
            if (document.getElementById('topic-mode-select').checked) {
                topic = document.getElementById('topic-select').value;
            } else {
                topic = document.getElementById('custom-topic-input').value.trim() || 'ch·ªß ƒë·ªÅ t·ª± ch·ªçn';
            }
            const level = document.getElementById('level-select').value;
            // Hi·ªÉn th·ªã th√¥ng tin ch·ªß ƒë·ªÅ, m·ª©c ƒë·ªô
            const topicMap = { travel: 'Du l·ªãch', school: 'H·ªçc t·∫≠p', work: 'C√¥ng vi·ªác', family: 'Gia ƒë√¨nh', food: '·∫®m th·ª±c' };
            const levelMap = { easy: 'D·ªÖ', medium: 'Trung b√¨nh', hard: 'Kh√≥' };
            document.getElementById('translate-info').innerHTML =
                `<div class='translate-info-topic'><span class='info-icon'>üìö</span>Ch·ªß ƒë·ªÅ: <span>${topicMap[topic] || topic}</span></div>` +
                `<div class='translate-info-level'><span class='info-icon'>‚≠ê</span>M·ª©c ƒë·ªô: <span>${levelMap[level] || level}</span></div>`;
            // G·ªçi backend l·∫•y c√¢u ti·∫øng Vi·ªát ƒë·∫ßu ti√™n
            document.getElementById('vi-sentence-box').textContent = 'ƒêang l·∫•y c√¢u...';
            document.getElementById('en-answer-input').value = '';
            document.getElementById('translate-feedback').textContent = '';
            document.getElementById('translate-next-box').textContent = '';
            try {
                const res = await fetch('http://127.0.0.1:8000/translate/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic, level })
                });
                const data = await res.json();
                document.getElementById('vi-sentence-box').textContent = data.vi_sentence;
                // L∆∞u tr·∫°ng th√°i cho phi√™n d·ªãch n√†y
                window.translateState = { topic, level, history: [data.vi_sentence], currentVi: data.vi_sentence };
                // ·∫®n popup g·ª£i √Ω n·∫øu ƒëang m·ªü
                document.getElementById('hint-popup').style.display = 'none';
                // ·∫®n popup g·ª£i √Ω n·∫øu ƒëang m·ªü
                document.getElementById('hint-popup').style.display = 'none';
            } catch (e) {
                document.getElementById('vi-sentence-box').textContent = 'L·ªói l·∫•y c√¢u, vui l√≤ng th·ª≠ l·∫°i.';
            }
        };
        // Quiz logic
        const quizModal = document.getElementById('quiz-modal');
        const quizContainer = document.getElementById('quiz-container');
        const startQuizBtn = document.getElementById('start-quiz-btn');
        const quizProgress = document.getElementById('quiz-progress');
        const quizQuestionBox = document.getElementById('quiz-question-box');
        const quizAnswersForm = document.getElementById('quiz-answers-form');
        const quizNextBtn = document.getElementById('quiz-next-btn');
        const quizSubmitBtn = document.getElementById('quiz-submit-btn');
        const quizResultBox = document.getElementById('quiz-result-box');

        let quizState = null;
        let readingPassage = '';
        let quizTopic = '';
        let quizLevel = '';

        startQuizBtn.onclick = async function () {
            // L·∫•y ch·ªß ƒë·ªÅ v√† m·ª©c ƒë·ªô
            const topic = document.getElementById('quiz-topic-select').value;
            const level = document.getElementById('quiz-level-select').value;
            quizTopic = topic;
            quizLevel = level;
            quizModal.style.display = 'none';
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('chat-container').style.display = 'none';
            document.getElementById('translate-container').style.display = 'none';
            document.getElementById('vocab-container').style.display = 'none'; // ·∫®n container t·ª´ v·ª±ng khi b·∫Øt ƒë·∫ßu quiz
            quizContainer.style.display = 'block';
            quizResultBox.innerHTML = '';
            quizProgress.textContent = '';
            quizQuestionBox.textContent = '';
            quizAnswersForm.innerHTML = '';
            quizNextBtn.style.display = 'none';
            quizSubmitBtn.style.display = 'none';
            readingPassage = '';
            if (topic === 'reading') {
                // Ch·ªâ hi·ªÉn th·ªã "ƒêang t·∫°o ƒëo·∫°n ƒë·ªçc hi·ªÉu..."
                quizProgress.textContent = '';
                quizQuestionBox.innerHTML = `<div style='text-align:center;font-size:1.1em;color:#7c3aed;font-weight:600;margin:32px 0;'>ƒêang t·∫°o ƒëo·∫°n ƒë·ªçc hi·ªÉu...</div>`;
                quizAnswersForm.innerHTML = '';
                quizNextBtn.style.display = 'none';
                quizSubmitBtn.style.display = 'none';
                try {
                    // Ch·ªâ g·ª≠i level l√™n backend
                    const resPassage = await fetch('http://127.0.0.1:8000/reading/passage', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ level })
                    });
                    const dataPassage = await resPassage.json();
                    readingPassage = dataPassage.passage || '';
                    if (!readingPassage) {
                        quizQuestionBox.innerHTML = `<div style='color:#ef4444;'>Kh√¥ng t·∫°o ƒë∆∞·ª£c ƒëo·∫°n ƒë·ªçc hi·ªÉu.</div>`;
                        return;
                    }
                    // Sau khi c√≥ passage, ti·∫øp t·ª•c l·∫•y quiz nh∆∞ c≈©
                } catch (e) {
                    quizQuestionBox.innerHTML = `<div style='color:#ef4444;'>L·ªói t·∫°o ƒëo·∫°n ƒë·ªçc hi·ªÉu.</div>`;
                    return;
                }
            }
            // G·ªçi API l·∫•y quiz, n·∫øu l√† reading th√¨ g·ª≠i k√®m passage
            try {
                const res = await fetch('http://127.0.0.1:8000/quiz/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(topic === 'reading' ? { topic, level, num_questions: 5, passage: readingPassage } : { topic, level, num_questions: 5 })
                });
                const data = await res.json();
                if (!data.questions || !Array.isArray(data.questions) || data.questions.length === 0) {
                    quizProgress.textContent = 'Kh√¥ng c√≥ c√¢u h·ªèi quiz ph√π h·ª£p.';
                    return;
                }
                quizState = {
                    questions: data.questions,
                    current: 0,
                    answers: Array(data.questions.length).fill(null)
                };
                renderQuizQuestion();
            } catch (e) {
                quizProgress.textContent = 'L·ªói l·∫•y quiz t·ª´ server.';
            }
        };

        function renderQuizQuestion() {
            if (!quizState) return;
            const idx = quizState.current;
            const q = quizState.questions[idx];
            quizProgress.textContent = `C√¢u ${idx + 1} / ${quizState.questions.length}`;
            // Hi·ªÉn th·ªã th√¥ng tin topic v√† level
            let topicText = '';
            let levelText = '';
            const topicMap = { grammar: 'Ng·ªØ ph√°p', vocabulary: 'T·ª´ v·ª±ng', reading: 'ƒê·ªçc hi·ªÉu' };
            topicText = topicMap[quizTopic] || quizTopic;
            levelText = quizLevel ? `Band ${quizLevel}` : '';
            let infoHtml = `<div style='margin-bottom:8px;font-size:1.05em;color:#7c3aed;font-weight:600;'>Ch·ªß ƒë·ªÅ: <span style='color:#2563eb;'>${topicText}</span> &nbsp; | &nbsp; M·ª©c ƒë·ªô: <span style='color:#d97706;'>${levelText}</span></div>`;
            // N·∫øu l√† reading, lu√¥n hi·ªÉn th·ªã to√†n b·ªô passage khi l√†m quiz
            if (quizTopic === 'reading' && readingPassage) {
                // Th√™m icon loa ph√°t √¢m cho ƒëo·∫°n ƒë·ªçc hi·ªÉu v√† c√¢u h·ªèi ti·∫øng Anh
                // T√°ch ƒëo·∫°n ƒë·ªçc hi·ªÉu th√†nh t·ª´ng t·ª´, m·ªói t·ª´ trong m·ªôt span
                // T√°ch ƒëo·∫°n ƒë·ªçc hi·ªÉu th√†nh t·ª´ng t·ª´, m·ªói t·ª´ trong m·ªôt span, ƒë·ªìng th·ªùi l∆∞u v·ªã tr√≠ b·∫Øt ƒë·∫ßu c·ªßa t·ª´ng t·ª´
                function wrapPassageWords(text) {
                    let wordStarts = [];
                    let html = '';
                    let idx = 0;
                    let re = /\S+/g;
                    let match;
                    while ((match = re.exec(text)) !== null) {
                        let word = match[0];
                        let start = match.index;
                        wordStarts.push({ start, word });
                    }
                    let lastIdx = 0;
                    wordStarts.forEach((w, i) => {
                        // Th√™m kho·∫£ng tr·∫Øng gi·ªØa c√°c t·ª´
                        html += text.slice(lastIdx, w.start);
                        html += `<span class='reading-word' data-idx='${i}' data-start='${w.start}'>${w.word}</span>`;
                        lastIdx = w.start + w.word.length;
                    });
                    html += text.slice(lastIdx);
                    return html.replace(/\n/g, '<br>');
                }
                quizQuestionBox.innerHTML = infoHtml +
                    `<div style='background:#f1f5f9;padding:14px 12px;border-radius:8px;margin-bottom:16px;display:flex;align-items:flex-start;gap:10px;'>
                <div style='flex:1;'>
                    <b>ƒêo·∫°n ƒë·ªçc hi·ªÉu:</b><br><span id='reading-passage-text'>${wrapPassageWords(readingPassage)}</span>
                </div>
                <button id='reading-passage-speak-btn' style='background:none;border:none;cursor:pointer;padding:0;margin:0;vertical-align:middle;display:inline-flex;align-items:center;' title='Nghe ph√°t √¢m ƒëo·∫°n ƒë·ªçc'>
                    <svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' style='vertical-align:middle;'>
                        <path fill='#3b82f6' d='M3 10v4h4l5 5V5L7 10H3zm13.5 2c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03zm2.5 0c0 3.04-1.64 5.64-4.5 6.32v-2.02c2.01-.45 3.5-2.24 3.5-4.3s-1.49-3.85-3.5-4.3V5.68c2.86.68 4.5 3.28 4.5 6.32z'/>
                    </svg>
                </button>
                <button id='reading-passage-pause-btn' style='background:none;border:none;cursor:pointer;padding:0 0 0 8px;margin:0;vertical-align:middle;display:inline-flex;align-items:center;' title='T·∫°m d·ª´ng/ti·∫øp t·ª•c ph√°t √¢m'>
                    <svg id='pause-icon' xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24'><rect x='6' y='5' width='4' height='14' fill='#f59e42'/><rect x='14' y='5' width='4' height='14' fill='#f59e42'/></svg>
                    <svg id='resume-icon' xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' style='display:none;'><polygon points='8,5 19,12 8,19' fill='#10b981'/></svg>
                </button>
            </div>` +
                    `<div style='display:flex;align-items:center;gap:8px;justify-content:flex-start;margin-bottom:8px;'>
                <span style='font-size:1.13em;font-weight:600;color:#222;'>${q.question}</span>
                <button class='quiz-speak-btn' style='background:none;border:none;cursor:pointer;padding:0;margin:0;vertical-align:middle;display:inline-flex;align-items:center;' title='Nghe ph√°t √¢m'>
                    <svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' style='vertical-align:middle;'>
                        <path fill='#3b82f6' d='M3 10v4h4l5 5V5L7 10H3zm13.5 2c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03zm2.5 0c0 3.04-1.64 5.64-4.5 6.32v-2.02c2.01-.45 3.5-2.24 3.5-4.3s-1.49-3.85-3.5-4.3V5.68c2.86.68 4.5 3.28 4.5 6.32z'/>
                    </svg>
                </button>
            </div>`;
                // G√°n s·ª± ki·ªán ph√°t √¢m cho icon loa ƒëo·∫°n ƒë·ªçc hi·ªÉu
                setTimeout(() => {
                    const passageBtn = document.getElementById('reading-passage-speak-btn');
                    const passageTextEl = document.getElementById('reading-passage-text');
                    if (passageBtn && passageTextEl) {
                        let currentUtter = null;
                        let isPaused = false;
                        const pauseBtn = document.getElementById('reading-passage-pause-btn');
                        const pauseIcon = document.getElementById('pause-icon');
                        const resumeIcon = document.getElementById('resume-icon');
                        passageBtn.onclick = function () {
                            let text = passageTextEl.textContent || passageTextEl.innerText || '';
                            if (text && 'speechSynthesis' in window) {
                                window.speechSynthesis.cancel();
                                passageTextEl.querySelectorAll('.reading-word').forEach(span => span.classList.remove('highlight'));
                                let spans = passageTextEl.querySelectorAll('.reading-word');
                                let starts = Array.from(spans).map(span => parseInt(span.getAttribute('data-start')));
                                const utter = new SpeechSynthesisUtterance(text);
                                utter.lang = 'en-US';
                                utter.onboundary = function (e) {
                                    if (e.name === 'word') {
                                        let idx = e.charIndex;
                                        let found = -1;
                                        for (let i = 0; i < starts.length; i++) {
                                            if (starts[i] <= idx) found = i;
                                            else break;
                                        }
                                        if (found >= 0) {
                                            spans.forEach(s => s.classList.remove('highlight'));
                                            spans[found].classList.add('highlight');
                                        }
                                    }
                                };
                                utter.onend = function () {
                                    passageTextEl.querySelectorAll('.reading-word').forEach(span => span.classList.remove('highlight'));
                                    pauseIcon.style.display = '';
                                    resumeIcon.style.display = 'none';
                                    isPaused = false;
                                    currentUtter = null;
                                };
                                currentUtter = utter;
                                window.speechSynthesis.speak(utter);
                                pauseIcon.style.display = '';
                                resumeIcon.style.display = 'none';
                                isPaused = false;
                            }
                        };
                        if (pauseBtn) {
                            pauseBtn.onclick = function () {
                                if (!currentUtter) return;
                                if (!isPaused) {
                                    window.speechSynthesis.pause();
                                    pauseIcon.style.display = 'none';
                                    resumeIcon.style.display = '';
                                    isPaused = true;
                                } else {
                                    window.speechSynthesis.resume();
                                    pauseIcon.style.display = '';
                                    resumeIcon.style.display = 'none';
                                    isPaused = false;
                                }
                            };
                        }
                    }
                }, 10);
            } else {
                quizQuestionBox.innerHTML = infoHtml +
                    `<div style='display:flex;align-items:center;gap:8px;justify-content:flex-start;margin-bottom:8px;'>
                <span style='font-size:1.13em;font-weight:600;color:#222;'>${q.question}</span>
                <button class='quiz-speak-btn' style='background:none;border:none;cursor:pointer;padding:0;margin:0;vertical-align:middle;display:inline-flex;align-items:center;' title='Nghe ph√°t √¢m'>
                    <svg xmlns='http://www.w3.org/2000/svg' width='22' height='22' viewBox='0 0 24 24' style='vertical-align:middle;'>
                        <path fill='#3b82f6' d='M3 10v4h4l5 5V5L7 10H3zm13.5 2c0-1.77-1.02-3.29-2.5-4.03v8.06c1.48-.74 2.5-2.26 2.5-4.03zm2.5 0c0 3.04-1.64 5.64-4.5 6.32v-2.02c2.01-.45 3.5-2.24 3.5-4.3s-1.49-3.85-3.5-4.3V5.68c2.86.68 4.5 3.28 4.5 6.32z'/>
                    </svg>
                </button>
            </div>`;
            }
            quizAnswersForm.innerHTML = '';
            q.options.forEach((opt, i) => {
                const id = `quiz-opt-${idx}-${i}`;
                const checked = quizState.answers[idx] === i ? 'checked' : '';
                quizAnswersForm.innerHTML += `<label style='display:block;margin-bottom:7px;cursor:pointer;'><input type='radio' name='quiz-answer' value='${i}' id='${id}' ${checked}> ${opt}</label>`;
            });
            quizNextBtn.style.display = (idx < quizState.questions.length - 1) ? 'inline-block' : 'none';
            quizSubmitBtn.style.display = (idx === quizState.questions.length - 1) ? 'inline-block' : 'none';
            quizResultBox.innerHTML = '';
            // G√°n s·ª± ki·ªán ph√°t √¢m cho icon loa
            setTimeout(() => {
                const speakBtns = document.getElementsByClassName('quiz-speak-btn');
                for (const btn of speakBtns) {
                    btn.onclick = function () {
                        let text = '';
                        // L·∫•y n·ªôi dung c√¢u h·ªèi
                        const span = btn.parentNode.querySelector('span');
                        if (span) text = span.textContent;
                        if (text && 'speechSynthesis' in window) {
                            window.speechSynthesis.cancel(); // D·ª´ng ph√°t √¢m c≈© tr∆∞·ªõc khi ph√°t c√¢u m·ªõi
                            const utter = new SpeechSynthesisUtterance(text);
                            utter.lang = 'en-US';
                            window.speechSynthesis.speak(utter);
                        }
                    };
                }
            }, 10);
        }

        quizAnswersForm.onchange = function (e) {
            if (!quizState) return;
            const idx = quizState.current;
            if (e.target && e.target.name === 'quiz-answer') {
                quizState.answers[idx] = parseInt(e.target.value);
            }
        };

        quizNextBtn.onclick = function () {
            if (!quizState) return;
            if (quizState.answers[quizState.current] == null) {
                quizResultBox.innerHTML = '<span style="color:#ef4444;">B·∫°n c·∫ßn ch·ªçn ƒë√°p √°n tr∆∞·ªõc khi sang c√¢u ti·∫øp theo.</span>';
                return;
            }
            quizState.current++;
            renderQuizQuestion();
        };

        quizSubmitBtn.onclick = function () {
            if (!quizState) return;
            if (quizState.answers[quizState.current] == null) {
                quizResultBox.innerHTML = '<span style="color:#ef4444;">B·∫°n c·∫ßn ch·ªçn ƒë√°p √°n tr∆∞·ªõc khi n·ªôp b√†i.</span>';
                return;
            }
            // ·∫®n c√¢u h·ªèi v√† ƒë√°p √°n khi n·ªôp b√†i
            quizQuestionBox.innerHTML = '';
            quizAnswersForm.innerHTML = '';
            let correct = 0;
            let html = '<h3>K·∫øt qu·∫£ Quiz</h3>';
            quizState.questions.forEach((q, i) => {
                const userAns = quizState.answers[i];
                const isCorrect = userAns === q.answer;
                if (isCorrect) correct++;
                let passageHtml = readingPassage;
                let evidenceHtml = '';
                if (q.evidence && readingPassage) {
                    const esc = s => s.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                    let ev = q.evidence.trim();
                    let regex = new RegExp(esc(ev), 'gi');
                    // N·∫øu kh√¥ng t√¨m th·∫•y, th·ª≠ b·ªè d·∫•u c√¢u cu·ªëi
                    if (!passageHtml.match(regex)) {
                        ev = ev.replace(/[.,!?]$/, '');
                        // Ch·∫•p nh·∫≠n evidence k·∫øt th√∫c b·∫±ng d·∫•u ch·∫•m, ph·∫©y, ho·∫∑c kh√¥ng c√≥ d·∫•u
                        regex = new RegExp(esc(ev) + '[.,!?]?', 'gi');
                    }
                    passageHtml = passageHtml.replace(regex, match => `<span class="highlight">${match}</span>`);
                    evidenceHtml = `<div style='color:#2563eb;font-size:0.98em;margin-top:4px;'>ƒêo·∫°n m√¥ t·∫£ li√™n quan: <span class="highlight">${q.evidence}</span></div>`;
                }
                html += `<div style='margin-bottom:10px;padding:8px 10px;background:#fff;border-radius:7px;box-shadow:0 1px 4px #ede9fe22;'>` +
                    (readingPassage ? `<div style='background:#f1f5f9;padding:10px 10px;border-radius:7px;margin-bottom:8px;'><b>ƒêo·∫°n ƒë·ªçc hi·ªÉu:</b><br>${passageHtml.replace(/\n/g, '<br>')}</div>` : '') +
                    `<div style='font-weight:600;color:#7c3aed;'>C√¢u ${i + 1}: ${q.question}</div>` +
                    `<div>ƒê√°p √°n c·ªßa b·∫°n: <b style='color:${isCorrect ? '#059669' : '#ef4444'};'>${q.options[userAns] ?? '-'}</b></div>` +
                    `<div>ƒê√°p √°n ƒë√∫ng: <b style='color:#2563eb;'>${q.options[q.answer]}</b></div>` +
                    `<div style='color:#d97706;'>Gi·∫£i th√≠ch: ${q.explain || '-'}</div>` +
                    evidenceHtml +
                    `</div>`;
            });
            html = `<div style='font-size:1.15em;font-weight:700;margin-bottom:12px;'>B·∫°n ƒë√∫ng ${correct}/${quizState.questions.length} c√¢u</div>` + html;
            // Th√™m n√∫t l√†m l·∫°i v√† l√†m m·ªõi quiz
            html += `<div style='margin-top:18px;display:flex;gap:12px;justify-content:center;'>` +
                `<button id='quiz-retry-btn' style='padding:7px 18px;border-radius:7px;background:#ede9fe;color:#7c3aed;font-weight:600;border:none;'>L√†m l·∫°i quiz n√†y</button>` +
                `<button id='quiz-new-btn' style='padding:7px 18px;border-radius:7px;background:linear-gradient(90deg,#a78bfa 0%,#7c3aed 100%);color:#fff;font-weight:600;border:none;'>L√†m quiz m·ªõi</button>` +
                `</div>`;
            quizResultBox.innerHTML = html;
            quizNextBtn.style.display = 'none';
            quizSubmitBtn.style.display = 'none';
            quizProgress.textContent = 'ƒê√£ ho√†n th√†nh Quiz!';
            // S·ª± ki·ªán cho n√∫t l√†m l·∫°i quiz
            document.getElementById('quiz-retry-btn').onclick = function () {
                quizState.current = 0;
                quizState.answers = Array(quizState.questions.length).fill(null);
                renderQuizQuestion();
            };
            // S·ª± ki·ªán cho n√∫t l√†m quiz m·ªõi
            document.getElementById('quiz-new-btn').onclick = function () {
                quizContainer.style.display = 'none';
                quizResultBox.innerHTML = '';
                document.getElementById('quiz-modal').style.display = 'flex';
            };
        };
        // X·ª≠ l√Ω g·ª≠i c√¢u d·ªãch, ch·∫•m ƒëi·ªÉm v√† l·∫•y c√¢u ti·∫øp theo
        // H√†m parseFeedback: ∆∞u ti√™n parse JSON, fallback sang text n·∫øu c·∫ßn
        function parseFeedback(feedback, userAnswer) {
            let score = '';
            let correct = '';
            let user = userAnswer;
            let explanation = '';
            if (feedback) {
                // T√¨m JSON object trong feedback b·∫±ng regex
                const match = feedback.match(/\{[\s\S]*\}/);
                if (match) {
                    try {
                        const obj = JSON.parse(match[0]);
                        explanation = obj.explanation || '';
                        user = obj.user_answer || userAnswer;
                        correct = obj.correct_answer || '';
                        score = obj.score || '';
                        return { user, correct, score, explanation };
                    } catch (e) {
                        return { user, correct, score, explanation: '' };
                    }
                }
                // N·∫øu kh√¥ng ph·∫£i JSON, kh√¥ng hi·ªÉn th·ªã g√¨
                return { user, correct, score, explanation: '' };
            }
            return { user, correct, score, explanation };
        }

        document.getElementById('send-translate-btn').onclick = async function () {
            const userAnswer = document.getElementById('en-answer-input').value.trim();
            if (!userAnswer) return;
            const state = window.translateState;
            if (!state || !state.topic || !state.level || !state.currentVi) return;
            const feedbackDiv = document.getElementById('translate-feedback');
            feedbackDiv.innerHTML = '<span style="color:#7c3aed;font-weight:600;">ƒêang ch·∫•m...</span>';
            try {
                if (!state.history_bilingual) state.history_bilingual = [];
                const res = await fetch('http://127.0.0.1:8000/translate/next', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        topic: state.topic,
                        level: state.level,
                        prev_history: state.history,
                        user_answer: userAnswer
                    })
                });
                const data = await res.json();
                document.getElementById('en-answer-input').value = '';
                // Ch·ªâ l·∫•y th√¥ng tin t·ª´ data.feedback (d√πng parseFeedback)
                let user = userAnswer, correct = '', score = '', explanation = '';
                if (data.feedback) {
                    const parsed = parseFeedback(data.feedback, userAnswer);
                    explanation = parsed.explanation;
                    user = parsed.user;
                    correct = parsed.correct;
                    score = parsed.score;
                }
                state.history_bilingual.push({
                    vi: state.currentVi,
                    en: user,
                    correct: correct,
                    score: score
                });
                renderTranslateHistory(state.history_bilingual);
                // L√†m n·ªïi b·∫≠t v√† xu·ªëng d√≤ng c√°c ph·∫ßn n·∫±m trong **...** v√† s·ªë th·ª© t·ª± 1., 2., ...
                let formatted = explanation || '';
                if (formatted) {
                    // Thay **...** th√†nh <span class='highlight'>...</span>
                    formatted = formatted.replace(/\*\*(.+?)\*\*/g, function (match, p1) {
                        return '<span class="highlight">' + p1 + '</span>';
                    });
                    // L√†m n·ªïi b·∫≠t s·ªë th·ª© t·ª± ƒë·∫ßu d√≤ng (1., 2., ...)
                    formatted = formatted.replace(/(\n|^)(\d+\.)/g, function (match, p1, p2) {
                        return '<br><span class="highlight">' + p2 + '</span>';
                    });
                    // T·ª± ƒë·ªông xu·ªëng d√≤ng tr∆∞·ªõc m·ªói ƒëo·∫°n highlight (n·∫øu c·∫ßn)
                    formatted = formatted.replace(/(<span class=\"highlight\">.+?<\/span>)/g, '<br>$1');
                    // Lo·∫°i b·ªè <br> ƒë·∫ßu n·∫øu c√≥
                    formatted = formatted.replace(/^<br>/, '');
                }
                feedbackDiv.innerHTML = formatted || '<span style="color:#ef4444;">Kh√¥ng nh·∫≠n ƒë∆∞·ª£c ph·∫£n h·ªìi.</span>';
            } catch (e) {
                feedbackDiv.innerHTML = '<span style="color:#ef4444;">L·ªói k·∫øt n·ªëi, vui l√≤ng th·ª≠ l·∫°i.</span>';
            }
        };

        // H√†m render l·ªãch s·ª≠ d·ªãch song ng·ªØ
        function renderTranslateHistory(history) {
            const box = document.getElementById('translate-history-list');
            if (!history || history.length === 0) {
                box.innerHTML = '<i>Ch∆∞a c√≥ l·ªãch s·ª≠.</i>';
                return;
            }
            let html = '';
            for (let i = history.length - 1; i >= 0; i--) {
                let scoreDisplay = (typeof history[i].score !== 'undefined' && history[i].score !== '') ? history[i].score : '-';
                let correctDisplay = (typeof history[i].correct !== 'undefined' && history[i].correct !== '') ? history[i].correct : '-';
                html += `<div style='margin-bottom:10px;padding:8px 10px;background:#fff;border-radius:7px;box-shadow:0 1px 4px #ede9fe22;'>` +
                    `<div style='color:#7c3aed;font-weight:600;font-size:1.01em;'>${history.length - i}. ${history[i].vi}</div>` +
                    `<div style='color:#2563eb;font-weight:500;margin-top:2px;'>B·∫°n: ${history[i].en}</div>` +
                    `<div style='color:#059669;font-weight:500;margin-top:2px;'>ƒê√∫ng: ${correctDisplay}</div>` +
                    `<div style='color:#d97706;font-weight:500;margin-top:2px;'>‚≠ê ƒêi·ªÉm: ${scoreDisplay}</div>` +
                    `</div>`;
            }
            box.innerHTML = html;
        }

        // N√∫t C√¢u ti·∫øp theo: l·∫•y c√¢u m·ªõi t·ª´ backend
        document.getElementById('next-vi-btn').onclick = async function () {
            const state = window.translateState;
            if (!state || !state.topic || !state.level) return;
            document.getElementById('vi-sentence-box').textContent = 'ƒêang l·∫•y c√¢u...';
            document.getElementById('hint-popup').style.display = 'none';
            document.getElementById('en-answer-input').value = '';
            document.getElementById('translate-feedback').textContent = '';
            document.getElementById('translate-next-box').textContent = '';
            try {
                // G·ª≠i to√†n b·ªô ƒëo·∫°n ƒë√£ d·ªãch (song ng·ªØ) l√™n backend ƒë·ªÉ AI sinh c√¢u m·ªõi n·ªëi ti·∫øp
                const bilingualHistory = state.history_bilingual || [];
                const paragraph = bilingualHistory.map(item => ({ vi: item.vi, en: item.en }));
                const res = await fetch('http://127.0.0.1:8000/translate/start', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ topic: state.topic, level: state.level, prev_history: state.history, paragraph })
                });
                const data = await res.json();
                document.getElementById('vi-sentence-box').textContent = data.vi_sentence;
                // L∆∞u l·∫°i c√¢u m·ªõi v√†o state
                state.currentVi = data.vi_sentence;
                state.history.push(data.vi_sentence);
                document.getElementById('hint-popup').style.display = 'none';

                // T·∫°o ƒëo·∫°n Vietsub v√† Engsub
                let vietArr = bilingualHistory.map(item => item.vi).filter(Boolean);
                let engArr = bilingualHistory.map(item => item.correct).filter(Boolean);
                let vietsub = vietArr.join('. ') + (vietArr.length ? '.' : '');
                let engsub = engArr.join('. ') + (engArr.length ? '.' : '');
                // Hi·ªÉn th·ªã l√™n giao di·ªán (ch·ªâ c·∫≠p nh·∫≠t n·ªôi dung, kh√¥ng t·∫°o l·∫°i div)
                let html = '';
                html += `<div style='font-weight:700;color:#7c3aed;margin-bottom:6px;'>Vietsub</div>`;
                html += `<div style='color:#222;margin-bottom:10px;'>${vietsub || '<i>Ch∆∞a c√≥ c√¢u n√†o.</i>'}</div>`;
                html += `<div style='font-weight:700;color:#2563eb;margin-bottom:6px;'>Engsub</div>`;
                html += `<div style='color:#2563eb;'>${engsub || '<i>Ch∆∞a c√≥ c√¢u n√†o.</i>'}</div>`;
                let paraDiv = document.getElementById('paragraph-view');
                if (paraDiv) paraDiv.innerHTML = html;
            } catch (e) {
                document.getElementById('vi-sentence-box').textContent = 'L·ªói l·∫•y c√¢u, vui l√≤ng th·ª≠ l·∫°i.';
            }
        };
        const messagesDiv = document.getElementById('messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        const homePage = document.getElementById('home-page');
        const chatContainer = document.getElementById('chat-container');
        const homeBtn = document.getElementById('home-btn');
        const practiceGrammarBtn = document.getElementById('practice-grammar-btn');

        // H√†m ·∫©n t·∫•t c·∫£ container ch·ª©c nƒÉng
        function hideAllContainers() {
            document.getElementById('home-page').style.display = 'none';
            document.getElementById('chat-container').style.display = 'none';
            document.getElementById('translate-container').style.display = 'none';
            document.getElementById('quiz-container').style.display = 'none';
            document.getElementById('vocab-container').style.display = 'none';
            document.getElementById('listening-container').style.display = 'none';
            document.getElementById('quiz-modal').style.display = 'none';
            document.getElementById('translate-modal').style.display = 'none';
            if ('speechSynthesis' in window) window.speechSynthesis.cancel();
        }

        // S·ª± ki·ªán cho n√∫t Trang ch·ªß

        homeBtn.onclick = function () {
            hideAllContainers();
            document.getElementById('home-page').style.display = 'block';
        };

        practiceGrammarBtn.onclick = function () {
            hideAllContainers();
            document.getElementById('chat-container').style.display = 'block';
            document.getElementById('hint-popup').style.display = 'none';
        };

        document.getElementById('practice-translate-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('translate-modal').style.display = 'block';
        };

    document.getElementById('vocab-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('vocab-container').style.display = 'block';
        };

    document.getElementById('quiz-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('quiz-modal').style.display = 'flex';
        };

    document.getElementById('listening-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('listening-container').style.display = 'block';
            document.getElementById('listening-question-box').textContent = '';
            document.getElementById('listening-audio-box').innerHTML = '';
            document.getElementById('listening-answer-input').value = '';
            document.getElementById('listening-feedback').textContent = '';
        };

        // S·ª± ki·ªán cho n√∫t Luy·ªán t·∫≠p s·ª≠a ng·ªØ ph√°p
        practiceGrammarBtn.onclick = function () {
            hideAllContainers();
            chatContainer.style.display = 'block';
            document.getElementById('hint-popup').style.display = 'none';
        };
        // --- Flashcard Vocabulary Logic ---
        // Danh s√°ch t·ª´ v·ª±ng m·∫´u
        const defaultVocabs = [
            { word: 'cat', meaning: 'con m√®o', phonetic: '/k√¶t/', image: 'https://images.unsplash.com/photo-1518717758536-85ae29035b6d?auto=format&fit=crop&w=200&q=80' },
            { word: 'dog', meaning: 'con ch√≥', phonetic: '/d…íg/', image: 'https://images.unsplash.com/photo-1518715308788-300e1e1b8a49?auto=format&fit=crop&w=200&q=80' },
            // H√¨nh m·ªõi cho "dog"
            // { word: 'dog', meaning: 'con ch√≥', phonetic: '/d…íg/', image: 'https://images.unsplash.com/photo-1518715308788-300e1e1b8a49?auto=format&fit=crop&w=200&q=80' },
            { word: 'dog', meaning: 'con ch√≥', phonetic: '/d…íg/', image: 'https://images.unsplash.com/photo-1518715308788-52b6b2a7c8a5?auto=format&fit=crop&w=200&q=80' },
            { word: 'apple', meaning: 'qu·∫£ t√°o', phonetic: '/Àà√¶p.…ôl/', image: 'https://images.unsplash.com/photo-1502741338009-cac2772e18bc?auto=format&fit=crop&w=200&q=80' },
            { word: 'book', meaning: 'quy·ªÉn s√°ch', phonetic: '/b äk/', image: 'https://images.unsplash.com/photo-1512820790803-83ca734da794?auto=format&fit=crop&w=200&q=80' }
        ];
        let vocabList = [];
        let vocabIndex = 0;

        // H√†m render flashcard
        function renderVocabFlashcard() {
            console.log('renderVocabFlashcard', {vocabList, vocabIndex, defaultVocabs});
            if (!Array.isArray(vocabList) || vocabList.length === 0) {
                vocabList = [...defaultVocabs];
                vocabIndex = 0;
            }
            if (!vocabList || vocabList.length === 0) {
                document.getElementById('vocab-word').textContent = 'Kh√¥ng c√≥ t·ª´ v·ª±ng.';
                document.getElementById('vocab-meaning').textContent = '';
                document.getElementById('vocab-phonetic').textContent = '';
                document.getElementById('vocab-progress').textContent = '';
                // Hide image on back
                if (document.getElementById('vocab-image-back')) document.getElementById('vocab-image-back').style.display = 'none';
                return;
            }
            const v = vocabList[vocabIndex];
            document.getElementById('vocab-word').textContent = v.word;
            // C·∫≠p nh·∫≠t n√∫t ph√°t √¢m
            const speakBtn = document.getElementById('vocab-speak-btn');
            if (speakBtn) {
                speakBtn.onclick = function () {
                    if ('speechSynthesis' in window) {
                        const utter = new SpeechSynthesisUtterance(v.word);
                        utter.lang = 'en-US';
                        window.speechSynthesis.speak(utter);
                    } else {
                        alert('Tr√¨nh duy·ªát c·ªßa b·∫°n kh√¥ng h·ªó tr·ª£ ph√°t √¢m!');
                    }
                };
            }
            document.getElementById('vocab-meaning').textContent = v.meaning;
            document.getElementById('vocab-phonetic').textContent = v.phonetic || '';
            document.getElementById('vocab-progress').textContent = `T·ª´ ${vocabIndex + 1} / ${vocabList.length}`;
            // Show image only on back
            let imgBackEl = document.getElementById('vocab-image-back');
            if (!imgBackEl) {
                imgBackEl = document.createElement('img');
                imgBackEl.id = 'vocab-image-back';
                imgBackEl.style.display = 'block';
                imgBackEl.style.margin = '0 auto 10px auto';
                imgBackEl.style.maxWidth = '90px';
                imgBackEl.style.maxHeight = '90px';
                imgBackEl.style.borderRadius = '12px';
                imgBackEl.style.boxShadow = '0 2px 8px #ede9fe55';
                const meaningDiv = document.getElementById('vocab-meaning');
                if (meaningDiv) meaningDiv.parentNode.insertBefore(imgBackEl, meaningDiv);
            }
            if (v.image) {
                imgBackEl.src = v.image;
                imgBackEl.alt = v.word;
                imgBackEl.style.display = 'block';
            } else {
                imgBackEl.style.display = 'none';
            }
            // Reset flip
            document.getElementById('vocab-flip-inner').classList.remove('flipped');
        }

        // S·ª± ki·ªán cho n√∫t Luy·ªán t·ª´ v·ª±ng
        document.getElementById('vocab-btn').onclick = function () {
            hideAllContainers();
            document.getElementById('vocab-container').style.display = 'block';
            vocabList = [...defaultVocabs];
            vocabIndex = 0;
            renderVocabFlashcard();
        };

        // S·ª± ki·ªán l·∫≠t flashcard
        document.getElementById('show-meaning-btn').onclick = function () {
            document.getElementById('vocab-flip-inner').classList.add('flipped');
        };
        document.getElementById('flip-back-btn').onclick = function () {
            document.getElementById('vocab-flip-inner').classList.remove('flipped');
        };

        // S·ª± ki·ªán chuy·ªÉn t·ª´ v·ª±ng
        document.getElementById('next-vocab-btn').onclick = function () {
            if (vocabList.length === 0) return;
            vocabIndex = (vocabIndex + 1) % vocabList.length;
            renderVocabFlashcard();
        };
        document.getElementById('prev-vocab-btn').onclick = function () {
            if (vocabList.length === 0) return;
            vocabIndex = (vocabIndex - 1 + vocabList.length) % vocabList.length;
            renderVocabFlashcard();
        };

        function appendMessage(text, sender) {
            const msgDiv = document.createElement('div');
            msgDiv.className = 'msg ' + sender;
            let html = '';
            if (sender === 'user') {
                html = '<span class="icon">üßë‚Äçüéì</span><div class="bubble">' + text + '</div>';
            } else {
                // T·ª± ƒë·ªông xu·ªëng d√≤ng v·ªõi c√°c d·∫•u g·∫°ch ƒë·∫ßu d√≤ng ho·∫∑c s·ªë th·ª© t·ª±
                let formatted = text.replace(/\n/g, '<br>');
                formatted = formatted.replace(/(- |‚Ä¢ |\d+\. )/g, '<br><b>$1</b>');
                html = '<span class="icon">ü§ñ</span><div class="bubble">' + formatted + '</div>';
            }
            msgDiv.innerHTML = html;
            messagesDiv.appendChild(msgDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }

        sendBtn.onclick = async function () {
            const text = userInput.value.trim();
            if (!text) return;
            appendMessage(text, 'user');
            userInput.value = '';
            appendMessage('...', 'ai');
            try {
                const res = await fetch('http://127.0.0.1:8000/chat', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ message: text })
                });
                const data = await res.json();
                // X√≥a d·∫•u "..." cu·ªëi c√πng
                messagesDiv.removeChild(messagesDiv.lastChild);
                appendMessage(data.reply, 'ai');
            } catch (e) {
                messagesDiv.removeChild(messagesDiv.lastChild);
                appendMessage('Error contacting AI.', 'ai');
            }
        };

        userInput.addEventListener('keydown', function (e) {
            if (e.key === 'Enter') sendBtn.click();
        });

        // N√∫t ƒë√≥ng popup g·ª£i √Ω
        document.getElementById('close-hint-btn').onclick = function () {
            document.getElementById('hint-popup').style.display = 'none';
        };
        // ƒê√≥ng popup g·ª£i √Ω khi click ra ngo√†i
        document.addEventListener('mousedown', function (event) {
            const hintPopup = document.getElementById('hint-popup');
            const showHintBtn = document.getElementById('show-hint-btn');
            if (!hintPopup || hintPopup.style.display === 'none') return;
            if (!hintPopup.contains(event.target) && !showHintBtn.contains(event.target)) {
                hintPopup.style.display = 'none';
            }
        });
        // Sidebar navigation logic
        document.getElementById('show-hint-btn').onclick = function () {
            const state = window.translateState;
            let vi = state && state.currentVi ? state.currentVi : '';
            let hintContent = document.getElementById('hint-content');
            if (!vi) {
                hintContent.innerHTML = '<i>Kh√¥ng c√≥ c√¢u ƒë·ªÉ g·ª£i √Ω.</i>';
                document.getElementById('hint-popup').style.display = 'block';
                return;
            }
            hintContent.innerHTML = '<span style="color:#7c3aed;">ƒêang l·∫•y g·ª£i √Ω...</span>';
            document.getElementById('hint-popup').style.display = 'block';
            fetch('http://127.0.0.1:8000/translate/hint', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ vi_sentence: vi })
            })
                .then(res => res.json())
                .then(data => {
                    if (!data || !data.hints || !Array.isArray(data.hints) || data.hints.length === 0) {
                        hintContent.innerHTML = '<i>Kh√¥ng c√≥ g·ª£i √Ω ƒë·∫∑c bi·ªát cho c√¢u n√†y.</i>';
                        return;
                    }
                    let html = '<ul style="padding-left:18px;margin:0;">';
                    for (const h of data.hints) {
                        if (h.word) {
                            html += `<li><b>${h.word}</b> <span style='color:#666;font-size:0.98em;margin-left:6px;'>${h.vi}</span></li>`;
                        } else if (h.grammar) {
                            html += `<li><b>${h.grammar}</b> <span style='color:#666;font-size:0.98em;margin-left:6px;'>${h.vi}</span></li>`;
                        } else if (h.info) {
                            html += `<li style='color:#888;'>${h.info}</li>`;
                        }
                    }
                    html += '</ul>';
                    hintContent.innerHTML = html;
                })
                .catch(() => {
                    hintContent.innerHTML = '<span style="color:#ef4444;">L·ªói l·∫•y g·ª£i √Ω t·ª´ server.</span>';
                });
        };
        // ·∫®n/hi·ªán sidebar khi nh·∫•n v√†o sidebar-toggle
        const sidebarEl = document.getElementById('sidebar');
        const sidebarToggle = document.getElementById('sidebar-toggle');
        const sidebarOpenBtn = document.getElementById('sidebar-open-btn');

        sidebarToggle.onclick = function () {
            // Toggle class ƒë·ªÉ ·∫©n/hi·ªán sidebar
            if (!sidebarEl.classList.contains('sidebar-collapsed')) {
                sidebarEl.classList.add('sidebar-collapsed');
                sidebarOpenBtn.style.display = 'flex';
            } else {
                sidebarEl.classList.remove('sidebar-collapsed');
                sidebarOpenBtn.style.display = 'none';
            }
        };

        // N√∫t m·ªü l·∫°i sidebar
        sidebarOpenBtn.onclick = function () {
            sidebarEl.classList.remove('sidebar-collapsed');
            sidebarOpenBtn.style.display = 'none';
        };
    </script>
    <style>
        /* ...existing code... */
    </style>
</body>

</html>